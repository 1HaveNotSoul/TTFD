# ‚úÖ –ì–û–¢–û–í–û: –ö–æ–ª–æ–Ω–∫–∞ telegram_id –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –ë–î Discord

## üéØ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `telegram_id` –≤ —Ç–∞–±–ª–∏—Ü—É `users` PostgreSQL –ë–î Discord –±–æ—Ç–∞ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ Telegram –∞–∫–∫–∞—É–Ω—Ç–æ–≤.

## üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –û–±–Ω–æ–≤–ª—ë–Ω `database_postgres.py`

**–§–∞–π–ª—ã:**
- `TTFD/discord-bot/py/database_postgres.py`
- `TTFD-Discord/py/database_postgres.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```sql
CREATE TABLE IF NOT EXISTS users (
    ...
    telegram_id TEXT  -- –ù–û–í–ê–Ø –ö–û–õ–û–ù–ö–ê
)

-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ë–î
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS telegram_id TEXT;

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX IF NOT EXISTS idx_users_telegram_id ON users(telegram_id);
```

### 2. –°–æ–∑–¥–∞–Ω–∞ SQL –º–∏–≥—Ä–∞—Ü–∏—è

**–§–∞–π–ª:** `TTFD/discord-bot/migrations/add_telegram_id.sql`

–ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS telegram_id TEXT;
CREATE INDEX IF NOT EXISTS idx_users_telegram_id ON users(telegram_id);
```

### 3. –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `TTFD/discord-bot/apply_telegram_migration.py`

–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
```bash
cd TTFD/discord-bot
python apply_telegram_migration.py
```

## üöÄ –î–µ–ø–ª–æ–π

- ‚úÖ –ö–æ–º–º–∏—Ç: `35e7758`
- ‚úÖ –ó–∞–ª–∏—Ç–æ –Ω–∞ GitHub
- üîÑ Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç Discord –±–æ—Ç–∞
- ‚úÖ –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –∫–æ–ª–æ–Ω–∫–∞ `telegram_id` –¥–æ–±–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## üîç –ß—Ç–æ —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
column "telegram_id" of relation "users" does not exist
LINE 1: UPDATE users SET telegram_id = '8398669299' WHERE id = '7395...
```

**–ü—Ä–∏—á–∏–Ω–∞:**
–ö–æ–º–∞–Ω–¥–∞ `/code` –≤ Telegram –±–æ—Ç–µ –ø—ã—Ç–∞–ª–∞—Å—å –∑–∞–ø–∏—Å–∞—Ç—å `telegram_id` –≤ —Ç–∞–±–ª–∏—Ü—É `users`, –Ω–æ —Ç–∞–∫–æ–π –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ.

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `telegram_id TEXT` –≤ —Ç–∞–±–ª–∏—Ü—É `users`
- –ö–æ–ª–æ–Ω–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ `init_tables()`
- –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ë–î –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ALTER TABLE ... ADD COLUMN IF NOT EXISTS`

## üìä –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–≤—è–∑–∫–∏ Discord-Telegram (–ü–û–õ–ù–´–ô –¶–ò–ö–õ)

### Discord –±–æ—Ç (‚úÖ –†–ê–ë–û–¢–ê–ï–¢):
1. `/getcode` - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–¥ (6 —Å–∏–º–≤–æ–ª–æ–≤)
2. –ö–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `game_stats['link_code']` (JSONB)
3. –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –≤ –õ–°
4. –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 3 –º–∏–Ω—É—Ç—ã

### Telegram –±–æ—Ç (‚úÖ –†–ê–ë–û–¢–ê–ï–¢):
1. `/code ABC123` - –ø—Ä–∏–≤—è–∑–∞—Ç—å —á–µ—Ä–µ–∑ –∫–æ–¥
2. –ß–∏—Ç–∞–µ—Ç –∫–æ–¥ –∏–∑ PostgreSQL –ë–î Discord –±–æ—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
4. –ü–æ–º–µ—á–∞–µ—Ç –∫–æ–¥ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –≤ `game_stats['link_code']['used'] = true`
5. **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–∏–≤—è–∑–∫—É:**
   - –í Discord –ë–î: `users.telegram_id = '8398669299'` ‚Üê –¢–ï–ü–ï–†–¨ –†–ê–ë–û–¢–ê–ï–¢
   - –í Telegram –ë–î: –ª–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ —á–µ—Ä–µ–∑ `db.link_discord()`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏:
- Discord: `/checklink` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π Telegram ID
- Telegram: `/checklink` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π Discord ID

### –û—Ç–≤—è–∑–∫–∞:
- Discord: `/unlink` - –æ—Ç–≤—è–∑–∞—Ç—å Telegram
- Telegram: `/unlink` - –æ—Ç–≤—è–∑–∞—Ç—å Discord

## ‚è≠Ô∏è –ß—Ç–æ –¥–∞–ª—å—à–µ

1. **–î–æ–∂–¥–∏—Å—å –¥–µ–ø–ª–æ—è** Railway (Discord Bot)
2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª:**
   ```
   Discord: /getcode ‚Üí –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –≤ –õ–°
   Telegram: /code ABC123 ‚Üí –ø—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã
   Telegram: /checklink ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
   Discord: /checklink ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
   ```
3. **–ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å:**
   - –í Discord –ë–î –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å—å `telegram_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `users`
   - –í Telegram –ë–î –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –ø—Ä–∏–≤—è–∑–∫–∞

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

**Discord –±–æ—Ç:**
- `TTFD/discord-bot/py/database_postgres.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ telegram_id
- `TTFD/discord-bot/py/slash_commands.py` - –∫–æ–º–∞–Ω–¥—ã /getcode, /checklink, /unlink
- `TTFD/discord-bot/migrations/add_telegram_id.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è
- `TTFD/discord-bot/apply_telegram_migration.py` - —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

**Telegram –±–æ—Ç:**
- `TTFD/telegram-bot/requirements.txt` - –¥–æ–±–∞–≤–ª–µ–Ω psycopg2-binary
- `TTFD/telegram-bot/handlers/discord_code.py` - –∫–æ–º–∞–Ω–¥—ã /code, /checklink, /unlink

## üìå –í–∞–∂–Ω–æ

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è Discord –±–æ—Ç–∞:
1. –ö–æ–ª–æ–Ω–∫–∞ `telegram_id` –¥–æ–±–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
2. –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–æ–ª–æ–Ω–∫–∞ –±—É–¥–µ—Ç `NULL` (–Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω)
3. –ü–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ —á–µ—Ä–µ–∑ `/code` –∫–æ–ª–æ–Ω–∫–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è Telegram ID
4. –ò–Ω–¥–µ–∫—Å `idx_users_telegram_id` —É—Å–∫–æ—Ä–∏—Ç –ø–æ–∏—Å–∫ –ø–æ Telegram ID

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–≤—è–∑–∫–∏ Discord-Telegram —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é:
- ‚úÖ Discord –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–¥—ã
- ‚úÖ Telegram —á–∏—Ç–∞–µ—Ç –∫–æ–¥—ã –∏–∑ PostgreSQL
- ‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –æ–±–µ –ë–î
- ‚úÖ –ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–≤—è–∑–∫–∏
- ‚úÖ –ú–æ–∂–Ω–æ –æ—Ç–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã
