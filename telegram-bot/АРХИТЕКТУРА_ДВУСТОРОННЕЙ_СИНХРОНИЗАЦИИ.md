# ğŸ”„ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ´Ğ²ÑƒÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ½ĞµĞ¹ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Telegram â†” Discord

**Ğ”Ğ°Ñ‚Ğ°:** 08.02.2026  
**Ğ’ĞµÑ€ÑĞ¸Ñ:** v3.0 + Bidirectional Sync

---

## ğŸ—ï¸ ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram Bot   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Sync Engine    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Discord Bot    â”‚
â”‚   (Python)      â”‚         â”‚  (Event-driven)  â”‚         â”‚   (discord.py)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                            â”‚                            â”‚
        â”‚                            â”‚                            â”‚
        â–¼                            â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PostgreSQL Database                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ account_linksâ”‚  â”‚ sync_events  â”‚  â”‚ transactions â”‚  â”‚ sync_state  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### 1. Account Links (Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¹)
```sql
discord_links:
  - id
  - telegram_user_id (FK users)
  - discord_user_id (unique)
  - verification_code
  - status (pending/active/revoked)
  - linked_at
  - last_sync_at  -- NEW
  - sync_enabled  -- NEW
```

### 2. Sync Events (Ğ½Ğ¾Ğ²Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°)
```sql
sync_events:
  - id (UUID)
  - idempotency_key (unique)
  - source (telegram/discord)
  - event_type (xp_change/balance_change/rank_change/achievement_unlock)
  - user_id (telegram_user_id)
  - payload (JSONB)
  - status (pending/processing/completed/failed)
  - processed_by (telegram/discord/both)
  - retries
  - error_message
  - created_at
  - processed_at
```

### 3. Transactions (Ğ½Ğ¾Ğ²Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°)
```sql
transactions:
  - id
  - idempotency_key (unique)
  - user_id (telegram_user_id)
  - source (telegram/discord)
  - type (xp/balance/achievement)
  - delta_xp
  - delta_balance
  - reason
  - metadata (JSONB)
  - created_at
```

### 4. Sync State (Ğ½Ğ¾Ğ²Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°)
```sql
sync_state:
  - user_id (telegram_user_id, PK)
  - last_telegram_xp
  - last_discord_xp
  - last_telegram_balance
  - last_discord_balance
  - last_telegram_rank
  - last_discord_rank
  - last_reconcile_at
  - reconcile_errors
  - updated_at
```

### 5. Rank Role Mapping (ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³)
```sql
rank_role_mappings:
  - id
  - rank_id (FK ranks)
  - discord_role_id
  - discord_role_name
  - priority
  - is_active
```

---

## ğŸ” ĞŸÑ€Ğ¾Ñ†ĞµÑÑ Ğ»Ğ¸Ğ½ĞºĞ¾Ğ²ĞºĞ¸ (Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹)

### Flow:
```
1. Telegram: /discord â†’ "ğŸ”— ĞŸÑ€Ğ¸Ğ²ÑĞ·Ğ°Ñ‚ÑŒ Discord"
2. TG Bot Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ´ (6 Ñ†Ğ¸Ñ„Ñ€, TTL 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚)
3. User Ğ² Discord: /link 123456
4. Discord Bot Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ĞºĞ¾Ğ´ â†’ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑ‚
5. Ğ¡Ğ²ÑĞ·ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ² Ğ‘Ğ” (status=active)
6. ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (TG â†’ Discord)
```

### Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ°:
- âœ… ĞšĞ¾Ğ´ Ğ¾Ğ´Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹
- âœ… TTL 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚
- âœ… 1 Telegram = 1 Discord (unique constraint)
- âœ… 1 Discord = 1 Telegram (unique constraint)
- âœ… Rate limit Ğ½Ğ° /link (5 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº Ğ² Ñ‡Ğ°Ñ)
- âœ… Audit log Ğ²ÑĞµÑ… Ğ»Ğ¸Ğ½ĞºĞ¾Ğ²Ğ¾Ğº

---

## ğŸ¯ Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ñ€Ğ°Ğ½Ğ³Ğ¾Ğ²: Rank-Derived

**Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾:** Ğ Ğ°Ğ½Ğ³ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ÑÑ Ğ¸Ğ· XP, Discord Ñ€Ğ¾Ğ»ÑŒ - Ğ¾Ñ‚Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ.

**ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾:**
- âœ… Ğ•Ğ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¸ÑÑ‚Ğ¸Ğ½Ñ‹ - XP
- âœ… ĞĞµĞ»ÑŒĞ·Ñ Ğ°Ğ±ÑŒÑĞ·Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Discord
- âœ… Ğ Ğ°Ğ½Ğ³ Ğ²ÑĞµĞ³Ğ´Ğ° ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹
- âœ… Ğ Ğ¾Ğ»ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ

**ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ°:**
1. XP Ğ¸Ğ·Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ â†’ Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ñ€Ğ°Ğ½Ğ³ â†’ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ Discord Ñ€Ğ¾Ğ»ÑŒ
2. Discord Ñ€Ğ¾Ğ»ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ° Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ â†’ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ (Ğ¸Ğ»Ğ¸ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ)
3. Ğ Ğ°Ğ½Ğ³ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡ĞµÑ€ĞµĞ· XP

**ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ° (Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼):**
- Dual-source: Ñ€Ğ°Ğ½Ğ³ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ² Discord
- ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹: Ğ°Ğ±ÑŒÑĞ·, Ñ€Ğ°ÑÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½, ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹
- Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾Ğ¹ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ²

---

## ğŸ”„ Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹Ğ½Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### Ğ¢Ğ¸Ğ¿Ñ‹ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹:
```python
EventType:
  - XP_CHANGE: Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ XP
  - BALANCE_CHANGE: Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°
  - RANK_CHANGE: Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ½Ğ³Ğ°
  - ACHIEVEMENT_UNLOCK: Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ
  - REWARD_GRANT: Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ° Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñ‹
```

### ĞŸĞ¾Ñ‚Ğ¾Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ:

#### 1. Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ² Telegram:
```
User Ğ¸Ğ³Ñ€Ğ°ĞµÑ‚ Ğ² Ğ¸Ğ³Ñ€Ñƒ â†’ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ XP
    â†“
GameService.add_xp()
    â†“
SyncService.create_event(
    source=telegram,
    type=xp_change,
    delta=+50,
    idempotency_key=f"tg_game_{game_id}_{user_id}"
)
    â†“
Event ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ² sync_events (status=pending)
    â†“
SyncWorker Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
    â†“
DiscordSyncService.apply_xp_change()
    â†“
Discord Bot Ğ²Ñ‹Ğ´Ğ°Ñ‘Ñ‚ XP Ñ‡ĞµÑ€ĞµĞ· API
    â†“
Event Ğ¿Ğ¾Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ÑÑ (status=completed, processed_by=discord)
```

#### 2. Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ² Discord:
```
User Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ XP Ğ² Discord (Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğ¹ Ñ‡Ğ°Ñ‚, Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ)
    â†“
DiscordBot.on_voice_state_update()
    â†“
DiscordSyncService.create_event(
    source=discord,
    type=xp_change,
    delta=+10,
    idempotency_key=f"ds_voice_{session_id}_{user_id}"
)
    â†“
Event ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ² sync_events (status=pending)
    â†“
SyncWorker Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
    â†“
TelegramSyncService.apply_xp_change()
    â†“
Telegram Bot Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ XP Ğ² Ğ‘Ğ”
    â†“
Event Ğ¿Ğ¾Ğ¼ĞµÑ‡Ğ°ĞµÑ‚ÑÑ (status=completed, processed_by=telegram)
```

### Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ¿Ğ¸Ğ½Ğ³-Ğ¿Ğ¾Ğ½Ğ³Ğ°:
```python
# ĞŸÑ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼:
if event.source == "telegram" and event.processed_by == "discord":
    # ĞĞµ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
    return

# Ğ˜Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ origin tracking:
event.origin = "telegram"
event.processed_by = ["discord"]

# ĞŸÑ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ² Discord:
if "discord" in event.processed_by:
    return  # Ğ£Ğ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾
```

---

## ğŸ”§ Ğ˜Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ

**ĞšĞ»ÑÑ‡ Ğ¸Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚Ğ¸:**
```python
idempotency_key = f"{source}_{type}_{entity_id}_{user_id}_{timestamp}"

# ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:
"tg_game_12345_67890_1234567890"
"ds_voice_session_abc_67890_1234567890"
"tg_achievement_first_win_67890"
```

**ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°:**
```python
async def create_event(self, event_data):
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    existing = await self.get_event_by_idempotency_key(
        event_data.idempotency_key
    )
    
    if existing:
        if existing.status == "completed":
            return existing  # Ğ£Ğ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾
        elif existing.status == "failed" and existing.retries < 3:
            # ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ°
            return await self.retry_event(existing)
        else:
            return existing
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
    return await self.insert_event(event_data)
```

---

## ğŸ® Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²

### 1. XP:
```
Telegram: user.xp += 50
    â†“
Event: xp_change(+50)
    â†“
Discord: add_xp_to_user(+50)
    â†“
Check rank change â†’ update role
```

### 2. Balance:
```
Telegram: user.coins += 100
    â†“
Event: balance_change(+100)
    â†“
Discord: update_balance_display(+100)
    â†“
(Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾) Ğ²Ñ‹Ğ´Ğ°Ñ‚ÑŒ Discord Ğ²Ğ°Ğ»ÑÑ‚Ñƒ
```

### 3. Rank:
```
Telegram: XP Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³ Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ° â†’ rank_up
    â†“
Event: rank_change(old=5, new=6)
    â†“
Discord: remove_role(rank_5) + add_role(rank_6)
    â†“
Announce in channel
```

### 4. Achievement:
```
Telegram: achievement unlocked
    â†“
Event: achievement_unlock(id=first_win)
    â†“
Discord: add_role(achievement_first_win)
    â†“
Send congratulations message
```

---

## ğŸ”„ Ğ ĞµĞ¶Ğ¸Ğ¼Ñ‹ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### 1. Realtime (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹):
```python
# ĞŸÑ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ
await sync_service.create_event(...)

# SyncWorker Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 5 ÑĞµĞºÑƒĞ½Ğ´
while True:
    events = await get_pending_events(limit=100)
    for event in events:
        await process_event(event)
    await asyncio.sleep(5)
```

### 2. Reconcile (Ñ„Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ğ¹):
```python
# ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€Ğ°ÑÑ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ
async def reconcile_user(user_id):
    tg_data = await get_telegram_data(user_id)
    ds_data = await get_discord_data(user_id)
    
    # Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼
    if tg_data.xp != ds_data.xp:
        # Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¸ÑÑ‚Ğ¸Ğ½Ñ‹ - Telegram
        await sync_to_discord(user_id, xp=tg_data.xp)
    
    if tg_data.rank != ds_data.rank:
        await sync_rank_to_discord(user_id, tg_data.rank)
```

---

## ğŸ›¡ï¸ Edge Cases

### 1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ° Discord ÑĞµÑ€Ğ²ĞµÑ€Ğµ:
```python
try:
    await discord_bot.add_role(user_id, role_id)
except discord.NotFound:
    # ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
    await mark_event_failed(event, "User not on server")
    await disable_sync_for_user(user_id)
```

### 2. ĞĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° Ğ²Ñ‹Ğ´Ğ°Ñ‡Ñƒ Ñ€Ğ¾Ğ»ĞµĞ¹:
```python
try:
    await discord_bot.add_role(user_id, role_id)
except discord.Forbidden:
    # ĞĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²
    await mark_event_failed(event, "Bot lacks permissions")
    await notify_admin("Bot needs role permissions")
```

### 3. Ğ¡Ğ¼ĞµĞ½Ğ° Ğ½Ğ¸ĞºĞ½ĞµĞ¹Ğ¼Ğ°:
```python
# ĞĞµ Ğ²Ğ»Ğ¸ÑĞµÑ‚ Ğ½Ğ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ user_id, Ğ° Ğ½Ğµ username
```

### 4. ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ:
```python
# Ğ˜Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ğ°ĞµÑ‚
if await event_exists(idempotency_key):
    return  # Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼
```

### 5. Ğ Ğ°ÑÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½ XP/Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°:
```python
# Reconcile job Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚
async def reconcile():
    diff = tg_xp - ds_xp
    if abs(diff) > 10:  # ĞŸĞ¾Ñ€Ğ¾Ğ³
        await sync_to_discord(xp=tg_xp)
        await log_reconcile(user_id, diff)
```

---

## ğŸ“Š ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ Ğ»Ğ¾Ğ³Ğ¸

### ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸:
- ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
- Ğ’Ñ€ĞµĞ¼Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
- ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ñ… ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¹
- ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼
- ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ reconcile Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹

### Ğ›Ğ¾Ğ³Ğ¸:
```python
logger.info(f"ğŸ”„ Sync event created: {event.id}")
logger.info(f"âœ… Event processed: {event.id} in {duration}ms")
logger.error(f"âŒ Event failed: {event.id}, error: {error}")
logger.warning(f"âš ï¸ Reconcile: user={user_id}, diff_xp={diff}")
```

### ĞĞ´Ğ¼Ğ¸Ğ½ĞºĞ°:
- ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ ÑĞ²ÑĞ·Ğ¾Ğº Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ²
- ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
- Ğ ÑƒÑ‡Ğ½Ğ°Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
- Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
- Audit trail Ğ²ÑĞµÑ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹

---

## ğŸš€ ĞŸĞ»Ğ°Ğ½ Ğ²Ğ½ĞµĞ´Ñ€ĞµĞ½Ğ¸Ñ (Ğ±ĞµĞ· Ğ´Ğ°ÑƒĞ½Ñ‚Ğ°Ğ¹Ğ¼Ğ°)

### Ğ­Ñ‚Ğ°Ğ¿ 1: ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ‘Ğ”
1. ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ (Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹)
2. Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ rank_role_mappings
3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ğ´ĞµĞºÑÑ‹

### Ğ­Ñ‚Ğ°Ğ¿ 2: Telegram Bot
1. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ SyncService
2. Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² GameService, UserService
3. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ SyncWorker
4. Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ° Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ¼ ÑĞµÑ€Ğ²ĞµÑ€Ğµ

### Ğ­Ñ‚Ğ°Ğ¿ 3: Discord Bot
1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Discord Bot (discord.py)
2. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /link, /unlink, /profile, /sync
3. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ (voice, messages)
4. Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ SyncService

### Ğ­Ñ‚Ğ°Ğ¿ 4: Reconcile
1. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ„Ğ¾Ğ½Ğ¾Ğ²ÑƒÑ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ reconcile
2. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ (ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚)
3. ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ñ€Ğ°ÑÑ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğ¹

### Ğ­Ñ‚Ğ°Ğ¿ 5: ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³
1. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
2. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹
3. ĞĞ´Ğ¼Ğ¸Ğ½ĞºĞ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ°

---

**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** ğŸ“‹ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°  
**Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑˆĞ°Ğ³:** Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²
