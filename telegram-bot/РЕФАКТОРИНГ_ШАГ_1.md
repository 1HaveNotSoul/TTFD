# üîß –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –®–∞–≥ 1: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ callback_data ‚úÖ
**–§–∞–π–ª:** `core/callbacks.py`

**–°–æ–∑–¥–∞–Ω–æ:**
- `CallbackBuilder` - –ø–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å callback —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- `CallbackDomain` enum - –¥–æ–º–µ–Ω—ã (menu, profile, game, ticket, admin, discord, economy)
- –ö–ª–∞—Å—Å—ã-—Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–º–µ–Ω–∞:
  - `MenuCallback`
  - `ProfileCallback`
  - `GameCallback` ‚úÖ
  - `TicketCallback`
  - `AdminCallback`
  - `DiscordCallback`
  - `EconomyCallback`

**–§–æ—Ä–º–∞—Ç:** `domain:action[:param1[:param2]]`

**–ü—Ä–∏–º–µ—Ä—ã:**
```python
# –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (—Ä–∞–∑–±—Ä–æ—Å–∞–Ω–æ –ø–æ handlers)
callback_data="guess_bet_50"
callback_data="ticket_view_42"
callback_data="admin_ticket_list_open"

# –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± (—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ)
GameCallback.guess_bet(50)        # "game:guess:bet:50"
TicketCallback.view(42)           # "ticket:view:42"
AdminCallback.ticket_list("open") # "admin:ticket:list:open"
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã (64 —Å–∏–º–≤–æ–ª–∞ Telegram limit)
- –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –õ–µ–≥–∫–æ –ø–∞—Ä—Å–∏—Ç—å
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ

---

### 2. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ä–æ—É—Ç–µ—Ä callback ‚úÖ
**–§–∞–π–ª:** `application/router.py`

**–°–æ–∑–¥–∞–Ω–æ:**
- `CallbackRouter` - –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–æ—á–Ω—ã—Ö callback
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —Ü–µ–ª—ã—Ö –¥–æ–º–µ–Ω–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
from application.router import callback_router
from core.callbacks import CallbackDomain, GameCallback

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–æ—á–Ω–æ–≥–æ callback
callback_router.register_exact(
    GameCallback.guess_start(),
    guess_handler.handle_start
)

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–æ–º–µ–Ω–∞ (–≤—Å–µ game:* callback)
callback_router.register_domain(
    CallbackDomain.GAME,
    game_router.route
)

# –í main_v3.py
app.add_handler(callback_router.get_handler())
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è handlers
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö callback
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ callback

---

### 3. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏–π —Å TTL ‚úÖ
**–§–∞–π–ª:** `core/state_manager.py`

**–°–æ–∑–¥–∞–Ω–æ:**
- `StateManager` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
- `StateKey` enum - –∫–ª—é—á–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π
- `StateTimeout` enum - —Ç–∞–π–º–∞—É—Ç—ã (5–º, 15–º, 30–º, 1—á)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –ø–æ —Ç–∞–π–º–∞—É—Ç—É
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
from core.state_manager import state_manager, StateKey, StateTimeout

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
state_manager.set_state(
    user_id=user.id,
    state_key=StateKey.TICKET_CREATING,
    data={'category': 'technical', 'step': 1},
    timeout=StateTimeout.MEDIUM  # 15 –º–∏–Ω—É—Ç
)

# –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
state = state_manager.get_state(user.id, StateKey.TICKET_CREATING)
if state:
    category = state['category']

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ
if state_manager.has_state(user.id, StateKey.TICKET_CREATING):
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–∞
    pass

# –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
state_manager.update_state_data(
    user.id,
    StateKey.TICKET_CREATING,
    {'step': 2, 'message': '–¢–µ–∫—Å—Ç —Ç–∏–∫–µ—Ç–∞'}
)

# –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
state_manager.clear_state(user.id, StateKey.TICKET_CREATING)

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
state_manager.clear_state(user.id)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –ø–æ —Ç–∞–π–º–∞—É—Ç—É
- –ù–µ—Ç "–∑–∞–≤–∏—Å—à–∏—Ö" —Å–æ—Å—Ç–æ—è–Ω–∏–π
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π

---

### 4. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Game Handlers ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- ‚úÖ `application/handlers/games/guess_handler.py`
- ‚úÖ `application/handlers/games/quiz_handler.py`
- ‚úÖ `application/handlers/games/spin_handler.py`
- ‚úÖ `application/handlers/games/games_menu_handler.py`
- ‚úÖ `application/handlers/games/game_router.py` (–Ω–æ–≤—ã–π)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
1. –í—Å–µ callback –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `GameCallback.*`
2. `context.user_data` –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ `state_manager`
3. –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è –∏–≥—Ä–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π (5 –º–∏–Ω—É—Ç)
4. –°–æ–∑–¥–∞–Ω `GameRouter` –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
5. –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
6. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π

**–ü—Ä–∏–º–µ—Ä —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:**
```python
# –î–û
async def handle_bet_selected(self, update, context):
    bet_amount = int(query.data.replace('guess_bet_', ''))
    context.user_data['guess_bet'] = bet_amount
    context.user_data['guess_number'] = secret_number

# –ü–û–°–õ–ï
async def handle_bet_selected(self, update, context):
    _, _, params = CallbackBuilder.parse(query.data)
    bet_amount = int(params[0])
    
    state_manager.set_state(
        user.id,
        StateKey.GAME_GUESS_ACTIVE,
        {
            'bet': bet_amount,
            'secret_number': secret_number,
            'session_id': session.id
        },
        timeout=StateTimeout.SHORT  # 5 –º–∏–Ω—É—Ç
    )
```

---

### 5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main_v3.py ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª:**
- ‚úÖ `main_v3.py`

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
1. –ò–º–ø–æ—Ä—Ç—ã –Ω–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º:
   - `callback_router`
   - `state_manager`
   - `CallbackDomain`
   - –í—Å–µ –∏–≥—Ä–æ–≤—ã–µ handlers –∏ `GameRouter`

2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:
   - `GameRepository`
   - `GameService`
   - –í—Å–µ –∏–≥—Ä–æ–≤—ã–µ handlers
   - `GameRouter`

3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:
   - –ö–æ–º–∞–Ω–¥–∞ `/games`
   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è `GameRouter` –≤ `callback_router`
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ `callback_router.get_handler()` –≤ app

4. –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π:
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö callback
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –∏–≥—Ä–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π –ø–æ —Ç–∞–π–º–∞—É—Ç—É
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö callback
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ callback –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π

---

## üìã –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö handlers

### –≠—Ç–∞–ø 1.1: –û–±–Ω–æ–≤–∏—Ç—å Game Handlers ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

**–°—Ç–∞—Ç—É—Å:** ‚úÖ 100% –∑–∞–≤–µ—Ä—à–µ–Ω–æ

**–§–∞–π–ª—ã:**
- ‚úÖ `application/handlers/games/guess_handler.py`
- ‚úÖ `application/handlers/games/quiz_handler.py`
- ‚úÖ `application/handlers/games/spin_handler.py`
- ‚úÖ `application/handlers/games/games_menu_handler.py`
- ‚úÖ `application/handlers/games/game_router.py` (—Å–æ–∑–¥–∞–Ω)
- ‚úÖ `main_v3.py` (–∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω)

---

### –≠—Ç–∞–ø 1.2: –û–±–Ω–æ–≤–∏—Ç—å Ticket Handlers ‚è≥ –°–õ–ï–î–£–Æ–©–ï–ï

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `application/handlers/tickets/ticket_handler.py`
- `application/handlers/tickets/admin_ticket_handler.py`

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –ó–∞–º–µ–Ω–∏—Ç—å callback –Ω–∞ `TicketCallback.*`
2. FSM —á–µ—Ä–µ–∑ `state_manager` –≤–º–µ—Å—Ç–æ ConversationHandler
3. –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–∞ (15 –º–∏–Ω—É—Ç)
4. –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
5. –°–æ–∑–¥–∞—Ç—å `TicketRouter`

---

### –≠—Ç–∞–ø 1.3: –û–±–Ω–æ–≤–∏—Ç—å Admin Handlers

**–§–∞–π–ª—ã:**
- `application/handlers/admin/admin_handler.py`

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –ó–∞–º–µ–Ω–∏—Ç—å callback –Ω–∞ `AdminCallback.*`
2. –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã
3. –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è broadcast, ban –∏ —Ç.–¥.
4. –°–æ–∑–¥–∞—Ç—å `AdminRouter`

---

### –≠—Ç–∞–ø 1.4: –û–±–Ω–æ–≤–∏—Ç—å User/Economy Handlers

**–§–∞–π–ª—ã:**
- `application/handlers/user/profile_handler.py`
- `application/handlers/user/leaderboard_handler.py`
- `application/handlers/economy/daily_handler.py`

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –ó–∞–º–µ–Ω–∏—Ç—å callback –Ω–∞ `ProfileCallback.*` –∏ `EconomyCallback.*`
2. –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤
3. –°–æ–∑–¥–∞—Ç—å `UserRouter` –∏ `EconomyRouter`

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–®–∞–≥ 1.2)
1. ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Game Handlers - –ó–ê–í–ï–†–®–ï–ù–û
2. ‚è≥ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Ticket Handlers - –°–õ–ï–î–£–Æ–©–ï–ï
3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–≥—Ä

### –°–∫–æ—Ä–æ (–®–∞–≥ 1.3-1.4)
1. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Admin Handlers
2. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ User/Economy Handlers
3. –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–æ—Ç–æ–º (–®–∞–≥ 2)
1. Discord –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
2. –£–ª—É—á—à–µ–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–π –º–µ—Ç—ã
3. –¢–∏–∫–µ—Ç—ã v2

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

**–î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:**
- Callback —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã –ø–æ handlers
- `context.user_data` –±–µ–∑ TTL
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏
- –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ):**
- ‚úÖ –í—Å–µ –∏–≥—Ä–æ–≤—ã–µ callback –≤ `core/callbacks.py`
- ‚úÖ –ò–≥—Ä–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å TTL –≤ `state_manager`
- ‚úÖ –ï–¥–∏–Ω—ã–π —Ä–æ—É—Ç–µ—Ä –¥–ª—è –∏–≥—Ä
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–≥—Ä
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ callback –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π

**–ü—Ä–æ–≥—Ä–µ—Å—Å:** 40% (–∏–≥—Ä—ã –≥–æ—Ç–æ–≤—ã, –æ—Å—Ç–∞–ª–æ—Å—å —Ç–∏–∫–µ—Ç—ã, –∞–¥–º–∏–Ω, –ø—Ä–æ—Ñ–∏–ª—å)

---

## üß™ –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–≥—Ä—ã
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
python main_v3.py

# –í Telegram:
/games - –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –∏–≥—Ä
üé≤ –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–≥—Ä—É
üß† –ö–≤–∏–∑ - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–≤–∏–∑
üé∞ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–ø–∏–Ω - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–∏–Ω

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã:
# 1. –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
# 2. –ü–æ–¥–æ–∂–¥–∞—Ç—å 6 –º–∏–Ω—É—Ç
# 3. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å - –¥–æ–ª–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å "–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ"
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å callback
```python
# –°–æ–∑–¥–∞—Ç—å callback
callback = GameCallback.guess_bet(50)
assert callback == "game:guess:bet:50"

# –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å
domain, action, params = CallbackBuilder.parse(callback)
assert domain == "game"
assert action == "guess"
assert params == ["bet", "50"]

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
assert CallbackBuilder.match(callback, CallbackDomain.GAME, "guess")
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è
```python
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
state_manager.set_state(
    123,
    StateKey.GAME_GUESS_ACTIVE,
    {'bet': 50},
    StateTimeout.SHORT
)

# –ü–æ–ª—É—á–∏—Ç—å
state = state_manager.get_state(123, StateKey.GAME_GUESS_ACTIVE)
assert state['bet'] == 50

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–π–º–∞—É—Ç (—á–µ—Ä–µ–∑ 6 –º–∏–Ω—É—Ç)
import time
time.sleep(360)
state = state_manager.get_state(123, StateKey.GAME_GUESS_ACTIVE)
assert state is None  # –ò—Å—Ç–µ–∫–ª–æ
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ—É—Ç–µ—Ä
```python
# –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
callback_router.register_domain(
    CallbackDomain.GAME,
    game_router.route
)

# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
stats = callback_router.get_stats()
print(stats)  # {'exact_routes': 0, 'domain_handlers': 1, 'total': 1}
```

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- ‚úÖ `core/callbacks.py` - —Å–∏—Å—Ç–µ–º–∞ callback
- ‚úÖ `application/router.py` - —Ä–æ—É—Ç–µ—Ä
- ‚úÖ `core/state_manager.py` - –º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏–π
- ‚úÖ `application/handlers/games/game_router.py` - –∏–≥—Ä–æ–≤–æ–π —Ä–æ—É—Ç–µ—Ä
- ‚úÖ `–†–ï–§–ê–ö–¢–û–†–ò–ù–ì_–®–ê–ì_1.md` - —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- ‚úÖ `main_v3.py` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–∞ –∏ state_manager
- ‚úÖ –í—Å–µ –∏–≥—Ä–æ–≤—ã–µ handlers - –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É

---

**–î–∞—Ç–∞:** 08.02.2026  
**–°—Ç–∞—Ç—É—Å:** üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ  
**–ü—Ä–æ–≥—Ä–µ—Å—Å –®–∞–≥–∞ 1:** 40% (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ + –∏–≥—Ä—ã –≥–æ—Ç–æ–≤—ã, –æ—Å—Ç–∞–ª–æ—Å—å —Ç–∏–∫–µ—Ç—ã/–∞–¥–º–∏–Ω/–ø—Ä–æ—Ñ–∏–ª—å)
