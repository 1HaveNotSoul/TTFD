# üîÑ –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Telegram ‚Üî Discord

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –≠—Ç–∞–ø 1 –≥–æ—Ç–æ–≤ (–±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)  
**–í–µ—Ä—Å–∏—è:** v3.0 + Bidirectional Sync

---

## üìñ –ß—Ç–æ —ç—Ç–æ?

–°–∏—Å—Ç–µ–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É Telegram –∏ Discord:
- XP, –±–∞–ª–∞–Ω—Å, —Ä–∞–Ω–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã
- –°–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π (reconcile)

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (40 –º–∏–Ω—É—Ç)

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```bash
psql $DATABASE_URL -f infrastructure/database/migrations/006_bidirectional_sync.sql
```

### 2. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ main_v3.py
```python
# –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã
from infrastructure.database.repositories.sync_repository import SyncRepository
from domain.services.sync_service import SyncService
from application.jobs.sync_worker import SyncWorker, ReconcileWorker, CleanupWorker

# –°–æ–∑–¥–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ —Å–µ—Ä–≤–∏—Å
sync_repo = SyncRepository(db_connection.get_pool())
sync_service = SyncService(sync_repo, user_repo, discord_repo)

# –û–±–Ω–æ–≤–∏—Ç—å GameService
game_service = GameService(
    game_repo, user_repo,
    season_service, achievement_service,
    sync_service  # NEW
)

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä—ã
sync_worker = SyncWorker(sync_service)
reconcile_worker = ReconcileWorker(sync_service)
cleanup_worker = CleanupWorker(sync_service)

asyncio.create_task(sync_worker.start())
asyncio.create_task(reconcile_worker.start())
asyncio.create_task(cleanup_worker.start())
```

### 3. –û–±–Ω–æ–≤–∏—Ç—å GameService
```python
# –í domain/services/game_service.py

def __init__(self, ..., sync_service=None):
    self.sync_service = sync_service

# –ü–æ—Å–ª–µ update_xp
if self.sync_service:
    await self.sync_service.create_xp_change_event(
        user_id=user.id,
        delta_xp=reward_xp,
        source="telegram",
        reason="game_guess",
        entity_id=str(session.id)
    )
```

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
```bash
python main_v3.py
# –°—ã–≥—Ä–∞—Ç—å –≤ –∏–≥—Ä—É
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ –ë–î
```

**–î–µ—Ç–∞–ª–∏:** `–ë–´–°–¢–†–´–ô_–°–¢–ê–†–¢_–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø.md`

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:

1. **–ë–´–°–¢–†–´–ô_–°–¢–ê–†–¢_–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø.md** ‚ö°
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (40 –º–∏–Ω—É—Ç)
   - –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
   - –û—Ç–ª–∞–¥–∫–∞

2. **–°–õ–ï–î–£–Æ–©–ò–ï_–®–ê–ì–ò_–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø.md** üìã
   - –ü–æ–ª–Ω—ã–π –ø–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
   - –°–æ–∑–¥–∞–Ω–∏–µ Discord Bot
   - –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

3. **–ê–†–•–ò–¢–ï–ö–¢–£–†–ê_–î–í–£–°–¢–û–†–û–ù–ù–ï–ô_–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò.md** üèóÔ∏è
   - –ü–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
   - –ü–æ—Ç–æ–∫–∏ —Å–æ–±—ã—Ç–∏–π
   - –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ edge cases

4. **–ì–û–¢–û–í–û_–î–í–£–°–¢–û–†–û–ù–ù–Ø–Ø_–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø_–≠–¢–ê–ü_1.md** ‚úÖ
   - –ü–æ–ª–Ω–∞—è —Å–≤–æ–¥–∫–∞ –≠—Ç–∞–ø–∞ 1
   - –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

5. **–§–ò–ù–ê–õ–¨–ù–ê–Ø_–°–í–û–î–ö–ê_–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø.md** üìä
   - –û–±—â–∞—è —Å–≤–æ–¥–∫–∞
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   - Roadmap

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

```
Telegram Bot ‚Üí SyncService ‚Üí sync_events ‚Üí SyncWorker ‚Üí Discord Bot
                    ‚Üì
              transactions
                    ‚Üì
              sync_state
```

### –ü–æ—Ç–æ–∫ —Å–æ–±—ã—Ç–∏—è:

```
1. User –∏–≥—Ä–∞–µ—Ç –≤ –∏–≥—Ä—É ‚Üí –ø–æ–ª—É—á–∞–µ—Ç XP
2. GameService —Å–æ–∑–¥–∞—ë—Ç —Å–æ–±—ã—Ç–∏–µ
3. –°–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î (status=pending)
4. SyncWorker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)
5. Discord Bot –ø–æ–ª—É—á–∞–µ—Ç XP
6. –°–æ–±—ã—Ç–∏–µ –ø–æ–º–µ—á–∞–µ—Ç—Å—è (status=completed)
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
domain/models/
  ‚îî‚îÄ‚îÄ sync_event.py              # –ú–æ–¥–µ–ª–∏: SyncEvent, Transaction, SyncState

infrastructure/database/
  ‚îú‚îÄ‚îÄ repositories/
  ‚îÇ   ‚îî‚îÄ‚îÄ sync_repository.py     # CRUD –¥–ª—è —Å–æ–±—ã—Ç–∏–π, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, —Å–æ—Å—Ç–æ—è–Ω–∏–π
  ‚îî‚îÄ‚îÄ migrations/
      ‚îî‚îÄ‚îÄ 006_bidirectional_sync.sql  # –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

domain/services/
  ‚îî‚îÄ‚îÄ sync_service.py            # –°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π

application/jobs/
  ‚îî‚îÄ‚îÄ sync_worker.py             # –§–æ–Ω–æ–≤—ã–µ –≤–æ—Ä–∫–µ—Ä—ã
```

---

## üîë –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
–ö–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `idempotency_key`:
```python
key = f"tg_game_12345_67890"
# –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ
```

### –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∏–Ω–≥-–ø–æ–Ω–≥–∞
–ü–æ–ª–µ `processed_by` –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª:
```python
if event.source == "telegram":
    processed_by = "discord"  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ Discord
```

### Rank-Derived —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
–†–∞–Ω–≥ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ XP:
```python
# Telegram: XP –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Üí –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ä–∞–Ω–≥ ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å Discord —Ä–æ–ª—å
# Discord: –†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å (—Ä–∞–Ω–≥ —Ç–æ–ª—å–∫–æ –æ—Ç XP)
```

### Reconcile
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π:
```python
# –ö–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
if telegram_xp != discord_xp:
    sync_to_discord(xp=telegram_xp)  # –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã - Telegram
```

---

## üéØ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏ –∏–≥—Ä–∞—Ö  
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)  
‚úÖ Reconcile –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π (–∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç)  
‚úÖ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π (–∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞)  
‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π  
‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å  
‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∏–Ω–≥-–ø–æ–Ω–≥–∞  

---

## ‚ùå –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç

‚ùå Discord Bot (–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å)  
‚ùå –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Discord ‚Üí Telegram  
‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–º–µ–Ω–∞ —Ä–æ–ª–µ–π —Ä–∞–Ω–≥–∞  
‚ùå –í—ã–¥–∞—á–∞ —Ä–æ–ª–µ–π –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ Discord  

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞

### –õ–æ–≥–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:
```
üöÄ SyncWorker –∑–∞–ø—É—â–µ–Ω: interval=5s, batch_size=100
üöÄ ReconcileWorker –∑–∞–ø—É—â–µ–Ω: interval=15m, batch_size=100
üöÄ CleanupWorker –∑–∞–ø—É—â–µ–Ω: interval=24h, retention=30d
```

### SQL –∑–∞–ø—Ä–æ—Å—ã:
```sql
-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
SELECT * FROM sync_events ORDER BY created_at DESC LIMIT 5;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
SELECT status, COUNT(*) FROM sync_events GROUP BY status;

-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
SELECT * FROM transactions ORDER BY created_at DESC LIMIT 5;
```

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –°–æ–±—ã—Ç–∏—è –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è?
```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ sync_service –ø–µ—Ä–µ–¥–∞–Ω
print(f"GameService.sync_service: {game_service.sync_service}")
```

### –°–æ–±—ã—Ç–∏—è –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è?
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
SELECT status, COUNT(*) FROM sync_events GROUP BY status;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏
SELECT error_message FROM sync_events WHERE status = 'failed';
```

---

## üìû –ü–æ–º–æ—â—å

**–ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π?**  
‚Üí –ß–∏—Ç–∞–π `–ë–´–°–¢–†–´–ô_–°–¢–ê–†–¢_–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø.md`

**–ù—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞?**  
‚Üí –ß–∏—Ç–∞–π `–ê–†–•–ò–¢–ï–ö–¢–£–†–ê_–î–í–£–°–¢–û–†–û–ù–ù–ï–ô_–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò.md`

**–•–æ—á–µ—à—å —Å–æ–∑–¥–∞—Ç—å Discord Bot?**  
‚Üí –ß–∏—Ç–∞–π `–°–õ–ï–î–£–Æ–©–ò–ï_–®–ê–ì–ò_–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø.md`

**–ù—É–∂–Ω–∞ –æ–±—â–∞—è —Å–≤–æ–¥–∫–∞?**  
‚Üí –ß–∏—Ç–∞–π `–§–ò–ù–ê–õ–¨–ù–ê–Ø_–°–í–û–î–ö–ê_–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø.md`

---

**–í–µ—Ä—Å–∏—è:** v3.0 + Bidirectional Sync (–≠—Ç–∞–ø 1)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏  
**–í—Ä–µ–º—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:** 40 –º–∏–Ω—É—Ç
