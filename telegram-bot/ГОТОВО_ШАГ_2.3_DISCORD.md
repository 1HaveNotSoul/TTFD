# ‚úÖ –ì–û–¢–û–í–û: –®–∞–≥ 2.3 - Discord –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–î–∞—Ç–∞:** 08.02.2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–í–µ—Ä—Å–∏—è:** v3.0 + –ò–≥—Ä–æ–≤–∞—è –º–µ—Ç–∞ + Discord

---

## üéØ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ú–æ–¥–µ–ª–∏ Discord –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚úÖ
**–§–∞–π–ª:** `domain/models/discord_link.py`

**–°–æ–∑–¥–∞–Ω—ã –º–æ–¥–µ–ª–∏:**
- `DiscordLink` - –ø—Ä–∏–≤—è–∑–∫–∞ Telegram ‚Üî Discord
- `DiscordRoleGrant` - –≤—ã–¥–∞—á–∞ Discord —Ä–æ–ª–µ–π
- `DiscordSyncLog` - –ª–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `LinkStatus` enum - —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–∏–≤—è–∑–∫–∏

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
```python
DiscordLink:
  - telegram_user_id, discord_user_id
  - verification_code (6 —Ü–∏—Ñ—Ä)
  - status (pending, active, expired, revoked)
  - expires_at (15 –º–∏–Ω—É—Ç)

DiscordRoleGrant:
  - role_name, role_id
  - reason_type, reason_id
  - is_granted, granted_at
  - error_message, retry_count
```

---

### 2. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î ‚úÖ
**–§–∞–π–ª:** `infrastructure/database/migrations/005_discord_integration.sql`

**–°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã:**
- `discord_links` - –ø—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
- `discord_role_grants` - –≤—ã–¥–∞—á–∞ —Ä–æ–ª–µ–π
- `discord_sync_logs` - –ª–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å: –æ–¥–∏–Ω Telegram = –æ–¥–∏–Ω Discord
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ –∫–æ–¥–æ–≤
- –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–æ–ª–µ–π
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
```bash
psql -U postgres -d ttfd_bot -f infrastructure/database/migrations/005_discord_integration.sql
```

---

### 3. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Discord ‚úÖ
**–§–∞–π–ª:** `infrastructure/database/repositories/discord_repository.py`

**–ú–µ—Ç–æ–¥—ã:**

#### –ü—Ä–∏–≤—è–∑–∫–∏:
- `get_active_link()` - –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –ø—Ä–∏–≤—è–∑–∫—É
- `get_link_by_code()` - –ø–æ–ª—É—á–∏—Ç—å –ø–æ –∫–æ–¥—É
- `create_link()` - —Å–æ–∑–¥–∞—Ç—å —Å 6-–∑–Ω–∞—á–Ω—ã–º –∫–æ–¥–æ–º
- `verify_link()` - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É
- `revoke_link()` - –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É

#### –†–æ–ª–∏:
- `create_role_grant()` - —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –æ –≤—ã–¥–∞—á–µ
- `mark_role_granted()` - –æ—Ç–º–µ—Ç–∏—Ç—å —á—Ç–æ –≤—ã–¥–∞–Ω–∞
- `mark_role_failed()` - –æ—Ç–º–µ—Ç–∏—Ç—å –æ—à–∏–±–∫—É
- `get_pending_role_grants()` - –ø–æ–ª—É—á–∏—Ç—å –Ω–µ–≤—ã–¥–∞–Ω–Ω—ã–µ
- `get_user_role_grants()` - –ø–æ–ª—É—á–∏—Ç—å —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### –õ–æ–≥–∏:
- `create_sync_log()` - —Å–æ–∑–¥–∞—Ç—å –ª–æ–≥
- `get_user_sync_logs()` - –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### –£—Ç–∏–ª–∏—Ç—ã:
- `expire_old_codes()` - –∏—Å—Ç–µ—á—å —Å—Ç–∞—Ä—ã–µ –∫–æ–¥—ã

---

### 4. Discord –∫–ª–∏–µ–Ω—Ç ‚úÖ
**–§–∞–π–ª:** `infrastructure/external/discord_client.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**

#### –†–æ–ª–∏:
- `add_role_to_member()` - –≤—ã–¥–∞—Ç—å —Ä–æ–ª—å
- `remove_role_from_member()` - –∑–∞–±—Ä–∞—Ç—å —Ä–æ–ª—å
- `get_guild_roles()` - –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ä–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞
- `find_role_by_name()` - –Ω–∞–π—Ç–∏ ID —Ä–æ–ª–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é

#### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
- `get_guild_member()` - –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- `is_member_on_server()` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- `get_member_roles()` - –ø–æ–ª—É—á–∏—Ç—å —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### –£—Ç–∏–ª–∏—Ç—ã:
- `test_connection()` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:**
- Discord API v10
- aiohttp –¥–ª—è async –∑–∞–ø—Ä–æ—Å–æ–≤
- Audit Log –¥–ª—è –ø—Ä–∏—á–∏–Ω –≤—ã–¥–∞—á–∏

---

### 5. –°–µ—Ä–≤–∏—Å Discord ‚úÖ
**–§–∞–π–ª:** `domain/services/discord_service.py`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**

#### –ü—Ä–∏–≤—è–∑–∫–∞:
- `create_link_request()` - —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å —Å –∫–æ–¥–æ–º
- `verify_link()` - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ –∫–æ–¥—É
- `get_active_link()` - –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é
- `revoke_link()` - –æ—Ç–æ–∑–≤–∞—Ç—å

#### –í—ã–¥–∞—á–∞ —Ä–æ–ª–µ–π:
- `grant_role()` - –≤—ã–¥–∞—Ç—å —Ä–æ–ª—å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–ª–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å)
- `_execute_role_grant()` - –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—ã–¥–∞—á—É —á–µ—Ä–µ–∑ API
- `process_pending_role_grants()` - –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–≤—ã–¥–∞–Ω–Ω—ã–µ
- `get_user_role_grants()` - –ø–æ–ª—É—á–∏—Ç—å —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### –£—Ç–∏–ª–∏—Ç—ã:
- `test_discord_connection()` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- `expire_old_codes()` - –∏—Å—Ç–µ—á—å –∫–æ–¥—ã

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏–≤—è–∑–∫–∞
2. –°–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ –ë–î
3. –ï—Å–ª–∏ –µ—Å—Ç—å Discord –∫–ª–∏–µ–Ω—Ç - –≤—ã–¥–∞—ë—Ç—Å—è —Å—Ä–∞–∑—É
4. –ï—Å–ª–∏ –Ω–µ—Ç - –∑–∞–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ø–æ—Ç–æ–º
5. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤—Å—ë

---

### 6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏ ‚úÖ
**–§–∞–π–ª:** `domain/services/achievement_service.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω `discord_service` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ü—Ä–∏ –≤—ã–¥–∞—á–µ –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–¥–∞—ë—Ç—Å—è Discord —Ä–æ–ª—å

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
```python
# –í _give_achievement_reward
if achievement.reward_discord_role and self.discord_service:
    await self.discord_service.grant_role(
        telegram_user_id=user_id,
        role_name=achievement.reward_discord_role,
        reason_type="achievement",
        reason_id=achievement.id
    )
```

**–†–æ–ª–∏ –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (9 —à—Ç—É–∫):**
- `achievement_pro` - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª (50 –ø–æ–±–µ–¥)
- `achievement_master` - –ú–∞—Å—Ç–µ—Ä –∏–≥—Ä (100 –ø–æ–±–µ–¥)
- `achievement_legend` - –õ–µ–≥–µ–Ω–¥–∞ (500 –ø–æ–±–µ–¥)
- `achievement_dedicated` - –ü—Ä–µ–¥–∞–Ω–Ω—ã–π –∏–≥—Ä–æ–∫ (500 –∏–≥—Ä)
- `achievement_streak7` - –ù–µ–¥–µ–ª—è —Å–∏–ª—ã (7 –¥–Ω–µ–π)
- `achievement_streak30` - –ú–µ—Å—è—Ü –ø—Ä–µ–¥–∞–Ω–Ω–æ—Å—Ç–∏ (30 –¥–Ω–µ–π)
- `achievement_season_top10` - –¢–æ–ø-10 —Å–µ–∑–æ–Ω–∞
- `achievement_season_champion` - –ß–µ–º–ø–∏–æ–Ω —Å–µ–∑–æ–Ω–∞
- `achievement_erudite` - –≠—Ä—É–¥–∏—Ç (10 –∫–≤–∏–∑–æ–≤ –ø–æ–¥—Ä—è–¥)

---

### 7. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–µ–∑–æ–Ω–∞–º–∏ ‚úÖ
**–§–∞–π–ª:** `domain/services/season_service.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω `discord_service` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ü—Ä–∏ –≤—ã–¥–∞—á–µ –Ω–∞–≥—Ä–∞–¥ –∑–∞ —Å–µ–∑–æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–¥–∞—ë—Ç—Å—è Discord —Ä–æ–ª—å

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
```python
# –í _give_season_reward
if reward.get('discord_role') and self.discord_service:
    await self.discord_service.grant_role(
        telegram_user_id=user_id,
        role_name=reward['discord_role'],
        reason_type="season_reward",
        reason_id=str(season_number)
    )
```

**–†–æ–ª–∏ –∑–∞ —Å–µ–∑–æ–Ω—ã:**
- `season_top10` - –¢–æ–ø-10 —Å–µ–∑–æ–Ω–∞
- `season_champion` - –ß–µ–º–ø–∏–æ–Ω —Å–µ–∑–æ–Ω–∞

---

### 8. Handlers –¥–ª—è Telegram ‚úÖ
**–§–∞–π–ª:** `application/handlers/discord/discord_handler.py`

**–ú–µ—Ç–æ–¥—ã:**
- `handle_discord_command()` - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é Discord
- `handle_link_start()` - –Ω–∞—á–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É (–ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥)
- `handle_unlink()` - –æ—Ç–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
- `handle_roles()` - –ø–æ–∫–∞–∑–∞—Ç—å –≤—ã–¥–∞–Ω–Ω—ã–µ —Ä–æ–ª–∏
- `handle_status()` - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- `handle_help()` - –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–º–æ—â—å

**–ö–æ–º–∞–Ω–¥–∞:** `/discord`

**Callback:**
- `discord_menu` - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- `discord_link_start` - –Ω–∞—á–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É
- `discord_unlink` - –æ—Ç–≤—è–∑–∞—Ç—å
- `discord_roles` - –º–æ–∏ —Ä–æ–ª–∏
- `discord_status` - —Å—Ç–∞—Ç—É—Å
- `discord_help` - –ø–æ–º–æ—â—å

---

### 9. –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ ‚úÖ

**–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–∞—á–∞ –≤ `main_v3.py`:**
```python
async def process_discord_roles():
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤—ã–¥–∞–Ω–Ω—ã—Ö Discord —Ä–æ–ª–µ–π"""
    while True:
        await asyncio.sleep(300)  # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        try:
            await discord_service.process_pending_role_grants()
            await discord_service.expire_old_codes()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ process_discord_roles: {e}")
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ–≤—ã–¥–∞–Ω–Ω—ã–µ —Ä–æ–ª–∏ (–µ—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏)
- –ò—Å—Ç–µ–∫–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –∫–æ–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–æ–ø—ã—Ç–∫–∏ (–¥–æ 3 —Ä–∞–∑)

---

## üöÄ –ó–∞–ø—É—Å–∫

### 1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env:
```bash
# Discord –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
DISCORD_BOT_TOKEN=your_discord_bot_token
DISCORD_GUILD_ID=your_guild_id
```

**–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–∞, –Ω–æ —Ä–æ–ª–∏ –±—É–¥—É—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã –≤ –ë–î.

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
```bash
cd TTFD/telegram-bot
psql -U postgres -d ttfd_bot -f infrastructure/database/migrations/005_discord_integration.sql
```

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞:
```bash
python main_v3.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Discord –∫–ª–∏–µ–Ω—Ç–∞...
‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Discord: TTFD Server
```

–ò–ª–∏:
```
‚ö†Ô∏è  Discord –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ (–Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞/guild_id)
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Telegram:
```
/discord
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
```
1. /discord ‚Üí üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å Discord
2. –ü–æ–ª—É—á–∏—Ç—å 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 123456)
3. –ù–∞ Discord —Å–µ—Ä–≤–µ—Ä–µ: /link 123456
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Telegram: /discord
   –û–∂–∏–¥–∞–µ—Ç—Å—è: "‚úÖ –¢–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç –ø—Ä–∏–≤—è–∑–∞–Ω"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–¥–∞—á–∞ —Ä–æ–ª–µ–π
```
1. –ü—Ä–∏–≤—è–∑–∞—Ç—å Discord
2. –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª")
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Discord: —Ä–æ–ª—å "achievement_pro" –≤—ã–¥–∞–Ω–∞
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Telegram: /discord ‚Üí üéÅ –ú–æ–∏ —Ä–æ–ª–∏
   –û–∂–∏–¥–∞–µ—Ç—Å—è: —Ä–æ–ª—å –≤ —Å–ø–∏—Å–∫–µ
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°–µ–∑–æ–Ω–Ω—ã–µ —Ä–æ–ª–∏
```
1. –ü—Ä–∏–≤—è–∑–∞—Ç—å Discord
2. –ü–æ–ø–∞—Å—Ç—å –≤ —Ç–æ–ø-10 —Å–µ–∑–æ–Ω–∞
3. –î–æ–∂–¥–∞—Ç—å—Å—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–µ–∑–æ–Ω–∞
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Discord: —Ä–æ–ª—å "season_top10" –≤—ã–¥–∞–Ω–∞
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û—Ç–≤—è–∑–∫–∞
```
1. /discord ‚Üí üîì –û—Ç–≤—è–∑–∞—Ç—å
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –ø—Ä–∏–≤—è–∑–∫–∞ –æ—Ç–æ–∑–≤–∞–Ω–∞
3. –†–æ–ª–∏ –≤ Discord –æ—Å—Ç–∞—é—Ç—Å—è
4. –ù–æ–≤—ã–µ —Ä–æ–ª–∏ –Ω–µ –≤—ã–¥–∞—é—Ç—Å—è
```

---

## üîç –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

1. **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–≤—è–∑–æ–∫:**
   - –û–¥–∏–Ω Telegram = –æ–¥–∏–Ω Discord
   - –û–¥–∏–Ω Discord = –æ–¥–∏–Ω Telegram
   - –ü—Ä–∏ –Ω–æ–≤–æ–π –ø—Ä–∏–≤—è–∑–∫–µ —Å—Ç–∞—Ä–∞—è –æ—Ç–∑—ã–≤–∞–µ—Ç—Å—è

2. **–ö–æ–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:**
   - 6 —Ü–∏—Ñ—Ä (1 000 000 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
   - –ò—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç
   - –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ

3. **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**
   - –†–æ–ª—å –ø–æ –æ–¥–Ω–æ–π –ø—Ä–∏—á–∏–Ω–µ –≤—ã–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
   - Constraint –≤ –ë–î

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

1. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å:**
   - –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ Discord API async
   - –ù–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –±–æ—Ç–∞

2. **–û—á–µ—Ä–µ–¥—å —Ä–æ–ª–µ–π:**
   - –ï—Å–ª–∏ Discord API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - —Ä–æ–ª–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
   - –î–æ 3 –ø–æ–ø—ã—Ç–æ–∫

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
   - –û—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
   - –õ–µ–≥–∫–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

### Edge cases:

1. **Discord API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:**
   - –†–æ–ª–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è –≤ –ë–î
   - –û–±—Ä–∞–±–æ—Ç–∞—é—Ç—Å—è –ø–æ–∑–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

2. **–†–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
   - –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
   - –ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è (retry_count = max)

3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
   - –†–æ–ª—å –Ω–µ –≤—ã–¥–∞—ë—Ç—Å—è
   - –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è

4. **–ö–æ–¥ –∏—Å—Ç—ë–∫:**
   - –ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
   - –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π

---

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```
UserService
    ‚Üì
DiscordService
    ‚Üì
AchievementService, SeasonService
    ‚Üì
GameService
```

### –ü–æ—Ç–æ–∫ –≤—ã–¥–∞—á–∏ —Ä–æ–ª–∏:

1. **–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ:**
```
GameService ‚Üí AchievementService.check_achievements()
    ‚Üí AchievementService._give_achievement_reward()
        ‚Üí DiscordService.grant_role()
            ‚Üí DiscordRepository.create_role_grant()
            ‚Üí DiscordClient.add_role_to_member()
```

2. **–°–µ–∑–æ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω:**
```
SeasonService.check_season_end()
    ‚Üí SeasonService._end_season()
        ‚Üí SeasonService._give_season_reward()
            ‚Üí DiscordService.grant_role()
```

3. **–§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
```
process_discord_roles() (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
    ‚Üí DiscordService.process_pending_role_grants()
        ‚Üí DiscordService._execute_role_grant()
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏

### –î–æ:
- ‚ùå –ù–µ—Ç —Å–≤—è–∑–∏ Telegram ‚Üî Discord
- ‚ùå –†–æ–ª–∏ –≤—ã–¥–∞—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é
- ‚ùå –ù–µ—Ç –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –¥–ª—è Discord –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### –ü–æ—Å–ª–µ:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–¥–∞—á–∞ 11 —Ä–æ–ª–µ–π
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
- ‚úÖ –û—á–µ—Ä–µ–¥—å —Ä–æ–ª–µ–π –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–Ω–µ –ª–æ–º–∞–µ—Ç –±–æ—Ç–∞)

---

## üéØ –ß—Ç–æ –¥–∞–ª—å—à–µ

### –≠—Ç–∞–ø 2.4: –¢–∏–∫–µ—Ç—ã v2
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π —Å —Ç–∏–∫–µ—Ç–∞–º–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ –æ—Ü–µ–Ω–∫–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

### –≠—Ç–∞–ø 2.5: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Discord
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–Ω–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Discord –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö
- Discord –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- –í—ã–¥–∞—á–∞ —Ä–æ–ª–µ–π –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ Discord

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞:
- [x] –ú–æ–¥–µ–ª–∏ Discord –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- [x] –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
- [x] –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- [x] Discord –∫–ª–∏–µ–Ω—Ç
- [x] –°–µ—Ä–≤–∏—Å Discord
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–µ–∑–æ–Ω–∞–º–∏
- [x] Handlers –¥–ª—è Telegram
- [x] –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ main_v3.py
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ó–∞–ø—É—Å–∫:
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env (DISCORD_BOT_TOKEN, DISCORD_GUILD_ID)
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 005_discord_integration.sql
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `/discord`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É –∞–∫–∫–∞—É–Ω—Ç–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –≤—ã–¥–∞—á—É —Ä–æ–ª–µ–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å .env, –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

**–§–∞–π–ª—ã:**
- `domain/models/discord_link.py`
- `infrastructure/database/migrations/005_discord_integration.sql`
- `infrastructure/database/repositories/discord_repository.py`
- `infrastructure/external/discord_client.py`
- `domain/services/discord_service.py`
- `application/handlers/discord/discord_handler.py`
- `domain/services/achievement_service.py` (–æ–±–Ω–æ–≤–ª—ë–Ω)
- `domain/services/season_service.py` (–æ–±–Ω–æ–≤–ª—ë–Ω)
- `core/config.py` (–æ–±–Ω–æ–≤–ª—ë–Ω)
- `main_v3.py` (–æ–±–Ω–æ–≤–ª—ë–Ω)
