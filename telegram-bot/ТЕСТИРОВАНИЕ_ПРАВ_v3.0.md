# üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∞–≤ v3.0

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
```bash
cd TTFD/telegram-bot
python main_v3.py
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
–û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É –≤ Telegram:
```
/start
/profile
```

---

## –¢–µ—Å—Ç 1: –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (USER)

### –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
```
/admin
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤
–¢—Ä–µ–±—É–µ—Ç—Å—è: admin
–¢–≤–æ—è —Ä–æ–ª—å: user
```

### –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å
```
/setrole 123456789 vip
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
–¢—Ä–µ–±—É–µ—Ç—Å—è: manage_users
–¢–≤–æ—è —Ä–æ–ª—å: user
```

---

## –¢–µ—Å—Ç 2: –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –Ω–∞ ADMIN

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ PostgreSQL
```sql
-- –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ –ë–î
psql -U postgres -d ttfd_bot

-- –ù–∞–π–¥–∏ —Å–≤–æ–π telegram_id
SELECT telegram_id, username, role FROM users;

-- –ò–∑–º–µ–Ω–∏ —Ä–æ–ª—å –Ω–∞ admin
UPDATE users SET role = 'admin' WHERE telegram_id = '—Ç–≤–æ–π_telegram_id';

-- –ü—Ä–æ–≤–µ—Ä—å
SELECT telegram_id, username, role FROM users WHERE telegram_id = '—Ç–≤–æ–π_telegram_id';
```

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç
```python
# set_admin.py
import asyncio
import asyncpg

async def set_admin(telegram_id: str):
    conn = await asyncpg.connect('postgresql://user:pass@localhost/ttfd_bot')
    await conn.execute(
        "UPDATE users SET role = 'admin' WHERE telegram_id = $1",
        telegram_id
    )
    await conn.close()
    print(f"‚úÖ –†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ admin –¥–ª—è {telegram_id}")

asyncio.run(set_admin('—Ç–≤–æ–π_telegram_id'))
```

---

## –¢–µ—Å—Ç 3: –ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã

### /admin - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
```
/admin
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
üîß –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

üë§ –¢–≤–æ—è —Ä–æ–ª—å: admin

üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚Ä¢ –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 5

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/admin_stats - –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/setrole <id> <role> - –ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å
/broadcast <—Ç–µ–∫—Å—Ç> - –†–∞—Å—Å—ã–ª–∫–∞ –≤—Å–µ–º

üí° –ò—Å–ø–æ–ª—å–∑—É–π /help –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
```

### /admin_stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```
/admin_stats
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: 5

üèÜ –¢–æ–ø-3:
1. –ò–≤–∞–Ω: 1500 XP
2. –ú–∞—Ä–∏—è: 1200 XP
3. –ü–µ—Ç—Ä: 800 XP
```

### /setrole - –ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å
```
/setrole 123456789 vip
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ò–≤–∞–Ω –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ vip
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```sql
SELECT telegram_id, username, role FROM users WHERE telegram_id = '123456789';
```

### /broadcast - –†–∞—Å—Å—ã–ª–∫–∞
```
/broadcast –ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
üì¢ –ù–∞—á–∏–Ω–∞—é —Ä–∞—Å—Å—ã–ª–∫—É –¥–ª—è 5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...

‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
‚Ä¢ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: 5
‚Ä¢ –û—à–∏–±–æ–∫: 0
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:
```
üì¢ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏:

–ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.
```

---

## –¢–µ—Å—Ç 4: –ò–µ—Ä–∞—Ä—Ö–∏—è —Ä–æ–ª–µ–π

### –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```sql
-- VIP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
UPDATE users SET role = 'vip' WHERE telegram_id = '111111111';

-- –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä
UPDATE users SET role = 'moderator' WHERE telegram_id = '222222222';

-- –ê–¥–º–∏–Ω
UPDATE users SET role = 'admin' WHERE telegram_id = '333333333';
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ /admin
- **USER** ‚Üí ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤
- **VIP** ‚Üí ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤
- **MODERATOR** ‚Üí ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤
- **ADMIN** ‚Üí ‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω
- **OWNER** ‚Üí ‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ /setrole
- **USER** ‚Üí ‚ùå –ù–µ—Ç –ø—Ä–∞–≤–∞ MANAGE_USERS
- **VIP** ‚Üí ‚ùå –ù–µ—Ç –ø—Ä–∞–≤–∞ MANAGE_USERS
- **MODERATOR** ‚Üí ‚ùå –ù–µ—Ç –ø—Ä–∞–≤–∞ MANAGE_USERS
- **ADMIN** ‚Üí ‚úÖ –ï—Å—Ç—å –ø—Ä–∞–≤–æ MANAGE_USERS
- **OWNER** ‚Üí ‚úÖ –ï—Å—Ç—å –ø—Ä–∞–≤–æ MANAGE_USERS

---

## –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ç—Ä–∏—Ü—ã –ø—Ä–∞–≤

### –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
```python
# test_permissions.py
from domain.models.permission import Role, Permission, has_permission

roles = [Role.USER, Role.VIP, Role.MODERATOR, Role.ADMIN, Role.OWNER]
permissions = [
    Permission.VIEW_PROFILE,
    Permission.VIP_DAILY_BONUS,
    Permission.CLOSE_TICKETS,
    Permission.MANAGE_USERS,
    Permission.SYSTEM_CONFIG
]

print("–ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤:\n")
print(f"{'–†–æ–ª—å':<15} | {'VIEW_PROFILE':<15} | {'VIP_BONUS':<15} | {'CLOSE_TICKETS':<15} | {'MANAGE_USERS':<15} | {'SYSTEM_CONFIG':<15}")
print("-" * 100)

for role in roles:
    row = f"{role.value:<15}"
    for perm in permissions:
        has = "‚úÖ" if has_permission(role, perm) else "‚ùå"
        row += f" | {has:<15}"
    print(row)
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤:

–†–æ–ª—å            | VIEW_PROFILE    | VIP_BONUS       | CLOSE_TICKETS   | MANAGE_USERS    | SYSTEM_CONFIG  
----------------------------------------------------------------------------------------------------
user            | ‚úÖ              | ‚ùå              | ‚ùå              | ‚ùå              | ‚ùå             
vip             | ‚úÖ              | ‚úÖ              | ‚ùå              | ‚ùå              | ‚ùå             
moderator       | ‚úÖ              | ‚úÖ              | ‚úÖ              | ‚ùå              | ‚ùå             
admin           | ‚úÖ              | ‚úÖ              | ‚úÖ              | ‚úÖ              | ‚ùå             
owner           | ‚úÖ              | ‚úÖ              | ‚úÖ              | ‚úÖ              | ‚úÖ             
```

---

## –¢–µ—Å—Ç 6: Edge Cases

### –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```
/setrole 999999999 admin
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚ùå –û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
```

### –ù–µ–≤–µ—Ä–Ω–∞—è —Ä–æ–ª—å
```
/setrole 123456789 superadmin
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Ä–æ–ª—å. –î–æ—Å—Ç—É–ø–Ω—ã–µ: user, vip, moderator, admin
```

### –ü—É—Å—Ç–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞
```
/broadcast
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /broadcast <—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è>
```

---

## –ß–µ–∫–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

- [ ] –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /admin
- [ ] –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /setrole
- [ ] –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /broadcast
- [ ] –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /admin
- [ ] –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /admin_stats
- [ ] –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Ä–æ–ª–∏ —á–µ—Ä–µ–∑ /setrole
- [ ] –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ /broadcast
- [ ] –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- [ ] –†–∞—Å—Å—ã–ª–∫–∞ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –ö—Ä–∞—Å–∏–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- [ ] –ò–µ—Ä–∞—Ä—Ö–∏—è —Ä–æ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –í–∫–ª—é—á–∏—Ç—å debug –ª–æ–≥–∏
```python
# main_v3.py
import logging
logging.basicConfig(level=logging.DEBUG)
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ PostgreSQL
```sql
-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–µ–π
SELECT telegram_id, username, role, updated_at 
FROM users 
ORDER BY updated_at DESC 
LIMIT 10;
```

---

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞: "Handler –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å user_service"
**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Å—å —á—Ç–æ AdminHandler —Å–æ–∑–¥–∞–Ω —Å user_service:
```python
admin_handler = AdminHandler(user_service)
```

### –ü—Ä–æ–±–ª–µ–º–∞: –†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –±–æ—Ç –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏:
```python
# –í –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç:
# –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å 123456789: Forbidden: bot was blocked by the user
```

---

**–î–∞—Ç–∞:** 08.02.2026  
**–í–µ—Ä—Å–∏—è:** v3.0  
**–≠—Ç–∞–ø:** 3
