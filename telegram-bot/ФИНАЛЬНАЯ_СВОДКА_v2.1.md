# üéâ –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–í–û–î–ö–ê - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ v2.1

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:

### 1. –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Ç–∏–∫–µ—Ç-—Å–∏—Å—Ç–µ–º–∞ —Å FSM ‚úÖ

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `handlers/tickets.py` (600+ —Å—Ç—Ä–æ–∫) - FSM –¥–ª—è —Ç–∏–∫–µ—Ç–æ–≤
- `utils/tickets.py` (–æ–±–Ω–æ–≤–ª—ë–Ω) - file locking, –Ω–æ–≤—ã–µ –ø–æ–ª—è

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –ü–æ—à–∞–≥–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ: –∫–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üí —Ç–µ–∫—Å—Ç ‚Üí –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- ‚úÖ –ü–æ–ª—è: `priority` (low/medium/high), `assigned_to` (admin_id)
- ‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: —Ñ–∏–ª—å—Ç—Ä—ã, "–≤–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É", –æ—Ç–≤–µ—Ç–∏—Ç—å, –∑–∞–∫—Ä—ã—Ç—å
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –Ω–æ–≤—ã–π —Ç–∏–∫–µ—Ç, –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∞, –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ File locking –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –∑–∞–ø–∏—Å–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
- ‚úÖ Timeout FSM: 5 –º–∏–Ω—É—Ç
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è: 10-1000 —Å–∏–º–≤–æ–ª–æ–≤
- ‚úÖ –û—Ç–º–µ–Ω–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ

### 2. –†–∞–∑–¥–µ–ª "üéÆ –ò–≥—Ä—ã" ‚úÖ

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `handlers/games.py` (400+ —Å—Ç—Ä–æ–∫) - FSM –¥–ª—è –∏–≥—Ä
- `utils/games.py` (300+ —Å—Ç—Ä–æ–∫) - –ª–æ–≥–∏–∫–∞ –∏–≥—Ä

**3 –∏–≥—Ä—ã:**

1. **üé≤ –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ**
   - –£–≥–∞–¥–∞–π –æ—Ç 1 –¥–æ 10
   - –°—Ç–∞–≤–∫–∏: 10, 25, 50, 100 –º–æ–Ω–µ—Ç
   - –í—ã–∏–≥—Ä—ã—à: —Å—Ç–∞–≤–∫–∞ √ó 3
   - XP: 50 –∑–∞ –ø–æ–±–µ–¥—É, 5 –∑–∞ –ø—Ä–æ–∏–≥—Ä—ã—à

2. **üß† –ö–≤–∏–∑**
   - 8 –≤–æ–ø—Ä–æ—Å–æ–≤ (—Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä)
   - –°—Ç–∞–≤–∫–∏: 10, 25, 50, 100 –º–æ–Ω–µ—Ç
   - –í—ã–∏–≥—Ä—ã—à: —Å—Ç–∞–≤–∫–∞ √ó 2
   - XP: 30 –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, 5 –∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

3. **üé∞ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–ø–∏–Ω**
   - –ë–µ—Å–ø–ª–∞—Ç–Ω–æ, 1 —Ä–∞–∑/24 —á–∞—Å–∞
   - –ù–∞–≥—Ä–∞–¥—ã: 10-500 –º–æ–Ω–µ—Ç, 5-100 XP
   - –°–∏—Å—Ç–µ–º–∞ –≤–µ—Å–æ–≤ –¥–ª—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏–∏

**–§—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
- ‚úÖ –ö—É–ª–¥–∞—É–Ω—ã (—Å–ø–∏–Ω)
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–≤–∫–∏ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
- ‚úÖ Timeout FSM: 3 –º–∏–Ω—É—Ç—ã

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤ ‚úÖ

**main.py:**
- ‚úÖ 4 ConversationHandler (—Ç–∏–∫–µ—Ç—ã: —Å–æ–∑–¥–∞–Ω–∏–µ + –æ—Ç–≤–µ—Ç, –∏–≥—Ä—ã: —É–≥–∞–¥–∞–π + –∫–≤–∏–∑)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (FSM –¥–æ –æ–±—ã—á–Ω—ã—Ö handlers)

**database.py:**
- ‚úÖ –ù–æ–≤—ã–µ –ø–æ–ª—è: `last_spin`, `games_played`, `games_won`, `total_coins_won`

**handlers/buttons.py:**
- ‚úÖ –†–æ—É—Ç–∏–Ω–≥ –¥–ª—è —Ç–∏–∫–µ—Ç–æ–≤ –∏ –∏–≥—Ä
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "üéÆ –ò–≥—Ä—ã" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é

**handlers/commands.py:**
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "üéÆ –ò–≥—Ä—ã" –≤ /start

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–¥–∞:

```
–ù–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤: 2
–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: 5
–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ: ~1500+
ConversationHandlers: 4
–°–æ—Å—Ç–æ—è–Ω–∏–π FSM: 6
Callback patterns: 30+
```

## üéØ –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è callback_data:

–í—Å–µ callback_data —Å–ª–µ–¥—É—é—Ç —Ñ–æ—Ä–º–∞—Ç—É: `<–º–æ–¥—É–ª—å>_<–¥–µ–π—Å—Ç–≤–∏–µ>_<–ø–∞—Ä–∞–º–µ—Ç—Ä—ã>`

**–ü—Ä–∏–º–µ—Ä—ã:**
```python
# –¢–∏–∫–µ—Ç—ã
"ticket_create_start"
"ticket_cat_general"
"ticket_pri_high"
"ticket_view_123"
"ticket_admin_list_open"

# –ò–≥—Ä—ã
"game_menu"
"game_guess_bet_50"
"game_quiz_ans_2"
"game_spin_do"
```

## üõ°Ô∏è Edge-cases –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã:

| Edge-case | –†–µ—à–µ–Ω–∏–µ |
|-----------|---------|
| –û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è | –ö–Ω–æ–ø–∫–∞ "‚ùå –û—Ç–º–µ–Ω–∞" –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ FSM |
| –¢–∞–π–º–∞—É—Ç | ConversationHandler timeout (5 –º–∏–Ω / 3 –º–∏–Ω) |
| –ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥ | –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã (10-1000 —Å–∏–º–≤–æ–ª–æ–≤) |
| –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ –¥–µ–π—Å—Ç–≤–∏–µ–º |
| –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç | –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ —Å—Ç–∞–≤–∫–æ–π |
| –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∑–∞–ø–∏—Å–∏ | File locking (fcntl/msvcrt) |
| –í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–≤–∫–∏ | –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∏–≥—Ä—ã —Å—Ç–∞–≤–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è |

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:

```
TTFD-Telegram/
‚îú‚îÄ‚îÄ main.py                    # ‚úÖ 4 ConversationHandlers
‚îú‚îÄ‚îÄ database.py                # ‚úÖ –ü–æ–ª—è –¥–ª—è –∏–≥—Ä
‚îú‚îÄ‚îÄ config.py                  # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ commands.py            # ‚úÖ –ö–Ω–æ–ø–∫–∞ –∏–≥—Ä
‚îÇ   ‚îú‚îÄ‚îÄ buttons.py             # ‚úÖ –†–æ—É—Ç–∏–Ω–≥
‚îÇ   ‚îú‚îÄ‚îÄ messages.py            # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ admin.py               # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ tickets.py             # üÜï FSM —Ç–∏–∫–µ—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ games.py               # üÜï FSM –∏–≥—Ä
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ tickets.py             # ‚úÖ File locking
‚îÇ   ‚îú‚îÄ‚îÄ games.py               # üÜï –õ–æ–≥–∏–∫–∞ –∏–≥—Ä
‚îÇ   ‚îî‚îÄ‚îÄ shop.py                # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ user_data.json
‚îÇ   ‚îú‚îÄ‚îÄ tickets.json
‚îÇ   ‚îî‚îÄ‚îÄ shop.json
‚îú‚îÄ‚îÄ –ü–õ–ê–ù_–û–ë–ù–û–í–õ–ï–ù–ò–Ø_v2.1.md
‚îú‚îÄ‚îÄ –û–ë–ù–û–í–õ–ï–ù–ò–ï_v2.1_–ì–û–¢–û–í–û.md
‚îú‚îÄ‚îÄ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï_v2.1.txt
‚îî‚îÄ‚îÄ –§–ò–ù–ê–õ–¨–ù–ê–Ø_–°–í–û–î–ö–ê_v2.1.md
```

## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å:

```bash
cd TTFD-Telegram
python main.py
```

**–í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª–∏:**
```
==================================================
üöÄ –ó–∞–ø—É—Å–∫ TTFD Telegram Bot v2.1...
==================================================
‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞
   –ê–¥–º–∏–Ω—ã: 123456789
‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã
   ‚Ä¢ –¢–∏–∫–µ—Ç-—Å–∏—Å—Ç–µ–º–∞ —Å FSM
   ‚Ä¢ –ò–≥—Ä—ã: –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ, –ö–≤–∏–∑, –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–ø–∏–Ω
   ‚Ä¢ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ç–∏–∫–µ—Ç–æ–≤
==================================================
‚úÖ Telegram –±–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!
   –û—Ç–ø—Ä–∞–≤—å /start –±–æ—Ç—É –≤ Telegram
==================================================
```

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ (FSM):

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: /start
–ë–æ—Ç: [–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏]

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–ù–∞–∂–∏–º–∞–µ—Ç "üé´ –¢–∏–∫–µ—Ç—ã"]
–ë–æ—Ç: [–ú–µ–Ω—é —Ç–∏–∫–µ—Ç–æ–≤]

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–ù–∞–∂–∏–º–∞–µ—Ç "‚ûï –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç"]
–ë–æ—Ç: –®–∞–≥ 1/4 - –í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–í—ã–±–∏—Ä–∞–µ—Ç "üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞"]
–ë–æ—Ç: –®–∞–≥ 2/4 - –û–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ù–µ –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –Ω–∞–≥—Ä–∞–¥—É"
–ë–æ—Ç: –®–∞–≥ 3/4 - –í—ã–±–µ—Ä–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–í—ã–±–∏—Ä–∞–µ—Ç "üü° –°—Ä–µ–¥–Ω–∏–π"]
–ë–æ—Ç: –®–∞–≥ 4/4 - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ [–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å—ë]

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–ù–∞–∂–∏–º–∞–µ—Ç "‚úÖ –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç"]
–ë–æ—Ç: ‚úÖ –¢–∏–∫–µ—Ç #1 —Å–æ–∑–¥–∞–Ω!
```

### –ò–≥—Ä–∞ "–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ":

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–ù–∞–∂–∏–º–∞–µ—Ç "üéÆ –ò–≥—Ä—ã"]
–ë–æ—Ç: [–ú–µ–Ω—é –∏–≥—Ä, –±–∞–ª–∞–Ω—Å: 100 –º–æ–Ω–µ—Ç]

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–ù–∞–∂–∏–º–∞–µ—Ç "üé≤ –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ"]
–ë–æ—Ç: –í—ã–±–µ—Ä–∏ —Å—Ç–∞–≤–∫—É

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–í—ã–±–∏—Ä–∞–µ—Ç "25 üí∞"]
–ë–æ—Ç: –ó–∞–≥–∞–¥–∞–Ω–æ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10. –í—ã–±–µ—Ä–∏ —á–∏—Å–ª–æ.

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: [–í—ã–±–∏—Ä–∞–µ—Ç "7"]
–ë–æ—Ç: üéâ –ü–û–ë–ï–î–ê! –¢—ã —É–≥–∞–¥–∞–ª —á–∏—Å–ª–æ 7!
     üí∞ –í—ã–∏–≥—Ä—ã—à: +75 –º–æ–Ω–µ—Ç
     ‚ú® XP: +50
```

### –ê–¥–º–∏–Ω –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Ç–∏–∫–µ—Ç:

```
–ê–¥–º–∏–Ω: [–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Üí üé´ –¢–∏–∫–µ—Ç—ã]
–ë–æ—Ç: [–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤]

–ê–¥–º–∏–Ω: [–ù–∞–∂–∏–º–∞–µ—Ç "üÜï –û—Ç–∫—Ä—ã—Ç—ã–µ"]
–ë–æ—Ç: [–°–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤]

–ê–¥–º–∏–Ω: [–í—ã–±–∏—Ä–∞–µ—Ç —Ç–∏–∫–µ—Ç #1]
–ë–æ—Ç: [–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–∫–µ—Ç–µ]

–ê–¥–º–∏–Ω: [–ù–∞–∂–∏–º–∞–µ—Ç "‚úã –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É"]
–ë–æ—Ç: ‚úÖ –¢–∏–∫–µ—Ç –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É!

–ê–¥–º–∏–Ω: [–ù–∞–∂–∏–º–∞–µ—Ç "üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å"]
–ë–æ—Ç: –ù–∞–ø–∏—à–∏ —Å–≤–æ–π –æ—Ç–≤–µ—Ç

–ê–¥–º–∏–Ω: "–ü—Ä–æ–≤–µ—Ä—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ"
–ë–æ—Ç: ‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!

[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: üí¨ –ê–¥–º–∏–Ω –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ —Ç–≤–æ–π —Ç–∏–∫–µ—Ç #1
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:

### File Locking (utils/tickets.py):

```python
# Windows
import msvcrt
def lock_file(f):
    msvcrt.locking(f.fileno(), msvcrt.LK_LOCK, 1)

# Linux
import fcntl
def lock_file(f):
    fcntl.flock(f.fileno(), fcntl.LOCK_EX)

# –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å
temp_file = TICKETS_FILE + '.tmp'
with open(temp_file, 'w') as f:
    lock_file(f)
    json.dump(data, f)
os.replace(temp_file, TICKETS_FILE)
```

### ConversationHandler (main.py):

```python
ticket_create_conv = ConversationHandler(
    entry_points=[
        CallbackQueryHandler(ticket_create_start, pattern="^ticket_create_start$")
    ],
    states={
        TICKET_CATEGORY: [
            CallbackQueryHandler(ticket_category_selected, pattern="^ticket_cat_"),
            CallbackQueryHandler(ticket_cancel, pattern="^ticket_cancel$")
        ],
        TICKET_MESSAGE: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, ticket_message_received),
            CallbackQueryHandler(ticket_cancel, pattern="^ticket_cancel$")
        ],
        # ...
    },
    fallbacks=[
        CallbackQueryHandler(ticket_cancel, pattern="^ticket_cancel$")
    ],
    conversation_timeout=300  # 5 –º–∏–Ω—É—Ç
)
```

### –°–∏—Å—Ç–µ–º–∞ –≤–µ—Å–æ–≤ –¥–ª—è —Å–ø–∏–Ω–∞ (utils/games.py):

```python
SPIN_REWARDS = [
    {'name': 'üí∞ 10 –º–æ–Ω–µ—Ç', 'coins': 10, 'xp': 5, 'weight': 30},   # 30%
    {'name': 'üí∞ 25 –º–æ–Ω–µ—Ç', 'coins': 25, 'xp': 10, 'weight': 25},  # 25%
    {'name': 'üéâ –î–ñ–ï–ö–ü–û–¢!', 'coins': 500, 'xp': 100, 'weight': 2}, # 2%
]

selected_reward = random.choices(rewards, weights=weights, k=1)[0]
```

## üéì –ß—Ç–æ –∏–∑—É—á–µ–Ω–æ:

1. ‚úÖ ConversationHandler —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
2. ‚úÖ File locking –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–π –∑–∞–ø–∏—Å–∏
3. ‚úÖ Timeout –¥–ª—è FSM
4. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
5. ‚úÖ –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
6. ‚úÖ –†–æ—É—Ç–∏–Ω–≥ callback_data
7. ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≤–µ—Å–æ–≤ –¥–ª—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏–∏
8. ‚úÖ –ö—É–ª–¥–∞—É–Ω—ã (cooldowns)

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:

### –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ SQLite (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):

–ï—Å–ª–∏ JSON —Å—Ç–∞–Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º–æ–π, –º–æ–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ SQLite:

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `database_sqlite.py`:**
```python
import sqlite3
from contextlib import contextmanager

@contextmanager
def get_db():
    conn = sqlite3.connect('data/bot.db')
    conn.row_factory = sqlite3.Row
    try:
        yield conn
        conn.commit()
    finally:
        conn.close()

def create_tables():
    with get_db() as conn:
        conn.execute('''
            CREATE TABLE IF NOT EXISTS users (
                telegram_id TEXT PRIMARY KEY,
                username TEXT,
                xp INTEGER DEFAULT 0,
                coins INTEGER DEFAULT 0,
                ...
            )
        ''')
        conn.execute('''
            CREATE TABLE IF NOT EXISTS tickets (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                telegram_id TEXT,
                message TEXT,
                priority TEXT,
                status TEXT,
                ...
            )
        ''')
```

**–°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ `migrate_to_sqlite.py`:**
```python
import json
from database_sqlite import get_db, create_tables

def migrate():
    create_tables()
    
    # –ú–∏–≥—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    with open('data/user_data.json') as f:
        data = json.load(f)
    
    with get_db() as conn:
        for user_id, user_data in data['users'].items():
            conn.execute('''
                INSERT INTO users VALUES (?, ?, ?, ?, ...)
            ''', (user_id, user_data['username'], ...))
    
    print("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")

if __name__ == '__main__':
    migrate()
```

–ù–æ –ø–æ–∫–∞ JSON —Å file locking —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ! üöÄ

## ‚úÖ –ò—Ç–æ–≥:

**–í—Å—ë –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!**

–ü—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º:
- ‚úÖ –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Ç–∏–∫–µ—Ç-—Å–∏—Å—Ç–µ–º–∞ —Å FSM
- ‚úÖ 3 –∏–≥—Ä—ã —Å –∫—É–ª–¥–∞—É–Ω–∞–º–∏ –∏ –Ω–∞–≥—Ä–∞–¥–∞–º–∏
- ‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ç–∏–∫–µ—Ç–æ–≤
- ‚úÖ File locking –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- ‚úÖ –í—Å–µ edge-cases –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
- ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ callback_data
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å python-telegram-bot 20.7

**–ó–∞–ø—É—Å–∫–∞–π –∏ —Ç–µ—Å—Ç–∏—Ä—É–π!** üéâ
