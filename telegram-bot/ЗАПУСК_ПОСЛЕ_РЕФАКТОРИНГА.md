# üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

## ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –®–∞–≥ 1.1 –¥–æ–±–∞–≤–ª–µ–Ω—ã:
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ callback
- State manager —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–±—Ä–æ—Å–æ–º
- –ò–≥—Ä–æ–≤–æ–π —Ä–æ—É—Ç–µ—Ä
- –§–æ–Ω–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π

## üìã –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü—Ä–æ–≤–µ—Ä—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–£–±–µ–¥–∏—Å—å —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –ø–∞–∫–µ—Ç—ã:
```bash
cd TTFD/telegram-bot
pip install -r requirements.txt
```

### 2. –ü—Ä–æ–≤–µ—Ä—å .env

–§–∞–π–ª `.env` –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
```env
# Telegram
TELEGRAM_BOT_TOKEN=your_bot_token

# PostgreSQL
DATABASE_URL=postgresql://user:password@localhost:5432/ttfd_bot

# Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
REDIS_URL=redis://localhost:6379/0

# OpenAI (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
OPENAI_API_KEY=your_openai_key
```

### 3. –ó–∞–ø—É—Å—Ç–∏ PostgreSQL

–£–±–µ–¥–∏—Å—å —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω –∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞:
```bash
# Windows
# –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω –≤ Services

# –°–æ–∑–¥–∞–π –±–∞–∑—É (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞)
psql -U postgres
CREATE DATABASE ttfd_bot;
\q
```

### 4. –ü—Ä–∏–º–µ–Ω–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
cd TTFD/telegram-bot
psql -U postgres -d ttfd_bot -f infrastructure/database/migrations/001_initial_schema.sql
psql -U postgres -d ttfd_bot -f infrastructure/database/migrations/002_update_game_history.sql
```

### 5. –ó–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞

```bash
python main_v3.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
============================================================
üöÄ –ó–∞–ø—É—Å–∫ TTFD Telegram Bot v3.0 (Clean Architecture)
============================================================

üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL...
üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis...
üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è repositories...
üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è services...
üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è handlers...
üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è handlers...
üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è callback router...
üßπ –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π...

============================================================
‚úÖ TTFD Bot v3.0 –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!
   ‚Ä¢ Clean Architecture
   ‚Ä¢ PostgreSQL
   ‚Ä¢ Redis Cache
   ‚Ä¢ Domain-Driven Design
   ‚Ä¢ Role-Based Access Control (RBAC)
   ‚Ä¢ Centralized Callback Router
   ‚Ä¢ State Manager with TTL
============================================================

üí° –û—Ç–ø—Ä–∞–≤—å /start –∏–ª–∏ /games –±–æ—Ç—É –≤ Telegram
```

---

## üéÆ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–≥—Ä

### –í Telegram –æ—Ç–ø—Ä–∞–≤—å:

```
/games
```

–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è –º–µ–Ω—é:
```
üéÆ –ò–≥—Ä—ã TTFD

üí∞ –¢–≤–æ–π –±–∞–ª–∞–Ω—Å: 100 –º–æ–Ω–µ—Ç
‚ú® XP: 0

–í—ã–±–µ—Ä–∏ –∏–≥—Ä—É:
[üé≤ –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ]
[üß† –ö–≤–∏–∑]
[üé∞ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–ø–∏–Ω]
[üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞]
```

### –ü—Ä–æ–≤–µ—Ä—å –∫–∞–∂–¥—É—é –∏–≥—Ä—É:

1. **üé≤ –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ**
   - –í—ã–±–µ—Ä–∏ —Å—Ç–∞–≤–∫—É
   - –í—ã–±–µ—Ä–∏ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10
   - –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

2. **üß† –ö–≤–∏–∑**
   - –í—ã–±–µ—Ä–∏ —Å—Ç–∞–≤–∫—É
   - –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å
   - –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

3. **üé∞ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–ø–∏–Ω**
   - –ö—Ä—É—Ç–∏ –∫–æ–ª–µ—Å–æ
   - –ü–æ–ª—É—á–∏ –Ω–∞–≥—Ä–∞–¥—É
   - –ü—Ä–æ–≤–µ—Ä—å –∫—É–ª–¥–∞—É–Ω (24 —á–∞—Å–∞)

4. **üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**
   - –ü–æ—Å–º–æ—Ç—Ä–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤

### –¢–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π:

1. –ù–∞—á–Ω–∏ –∏–≥—Ä—É "–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ"
2. –í—ã–±–µ—Ä–∏ —Å—Ç–∞–≤–∫—É
3. **–ù–ï –≤—ã–±–∏—Ä–∞–π —á–∏—Å–ª–æ**
4. –ü–æ–¥–æ–∂–¥–∏ 6 –º–∏–Ω—É—Ç
5. –ü–æ–ø—Ä–æ–±—É–π –≤—ã–±—Ä–∞—Ç—å —á–∏—Å–ª–æ

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
‚è∞ –í—Ä–µ–º—è –∏–≥—Ä—ã –∏—Å—Ç–µ–∫–ª–æ
```

–°—Ç–∞–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

–ü—Ä–∏ –∏–≥—Ä–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–ª—è—Ç—å—Å—è –ª–æ–≥–∏:

```
üìû Callback: game:menu –æ—Ç User (123456)
üîÑ –°–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: user=123456, state=game_guess_active, timeout=300s
üìû Callback: game:guess:bet:50 –æ—Ç User (123456)
üìû Callback: game:guess:num:7 –æ—Ç User (123456)
üßπ –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ: user=123456, state=game_guess_active
```

–ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç:
```
üßπ –û—á–∏—â–µ–Ω–æ –∏—Å—Ç–µ–∫—à–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π: 2
```

---

## ‚ùå –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. PostgreSQL –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

**–û—à–∏–±–∫–∞:**
```
‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: connection refused
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å `DATABASE_URL` –≤ `.env`
- –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞

### 2. Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:**
```
‚ö†Ô∏è  Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º MemoryCache
```

**–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!** –ë–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å MemoryCache (–±–µ–∑ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∫—ç—à–∞).

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis:
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏ Redis
# Windows: —Å–∫–∞—á–∞–π —Å https://github.com/microsoftarchive/redis/releases

# –ó–∞–ø—É—Å—Ç–∏ Redis
redis-server
```

### 3. –ò–≥—Ä—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** Callback –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω –±–µ–∑ –æ—à–∏–±–æ–∫
2. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
3. –£–±–µ–¥–∏—Å—å —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞

### 4. –°–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–≥—Ä–∞ "–∑–∞–≤–∏—Å–ª–∞"

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–æ–¥–æ–∂–¥–∏ 5 –º–∏–Ω—É—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞)
- –ò–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞
- –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞

–ü–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–≥—Ä –ø—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:

```python
# –í –∫–æ–Ω—Å–æ–ª–∏ Python
from core.state_manager import state_manager
from application.router import callback_router

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π
print(state_manager.get_stats())
# {'total_users': 5, 'total_states': 2, 'avg_states_per_user': 0.4}

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞
print(callback_router.get_stats())
# {'exact_routes': 0, 'domain_handlers': 1, 'total': 1}
```

---

## üéØ –ß—Ç–æ –¥–∞–ª—å—à–µ

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–≥—Ä:

1. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Ticket Handlers** (–≠—Ç–∞–ø 1.2)
2. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Admin Handlers** (–≠—Ç–∞–ø 1.3)
3. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ User/Economy Handlers** (–≠—Ç–∞–ø 1.4)

–ó–∞—Ç–µ–º:
- Discord –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- –£–ª—É—á—à–µ–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–π –º–µ—Ç—ã
- –¢–∏–∫–µ—Ç—ã v2

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ß–∏—Ç–∞–π:**
- `–ì–û–¢–û–í–û_–†–ï–§–ê–ö–¢–û–†–ò–ù–ì_–®–ê–ì_1.1_–ò–ì–†–´.md` - —á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ
- `–†–ï–§–ê–ö–¢–û–†–ò–ù–ì_–®–ê–ì_1.md` - –æ–±—â–∏–π –ø–ª–∞–Ω
- `core/callbacks.py` - —Å–∏—Å—Ç–µ–º–∞ callback
- `core/state_manager.py` - –º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏–π

---

**–î–∞—Ç–∞:** 08.02.2026  
**–í–µ—Ä—Å–∏—è:** v3.0 + –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –®–∞–≥ 1.1  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É
