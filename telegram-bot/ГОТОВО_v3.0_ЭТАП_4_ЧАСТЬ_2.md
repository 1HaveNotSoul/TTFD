# ‚úÖ –ì–û–¢–û–í–û: –≠—Ç–∞–ø 4 (–ß–∞—Å—Ç—å 2) - –¢–∏–∫–µ—Ç—ã

## üéØ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ú–æ–¥–µ–ª–∏ —Ç–∏–∫–µ—Ç–æ–≤
**–§–∞–π–ª:** `domain/models/ticket.py`

- **TicketStatus** enum (open, in_progress, closed)
- **TicketPriority** enum (low, medium, high)
- **TicketCategory** enum (general, technical, suggestion, complaint)
- **Ticket** - —Ç–∏–∫–µ—Ç —Å –ø–æ–ª—è–º–∏
- **TicketMessage** - —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–∏–∫–µ—Ç–µ
- **TicketStats** - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤
- **–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã** - CATEGORY_NAMES, PRIORITY_NAMES, STATUS_EMOJI

### 2. TicketRepository
**–§–∞–π–ª:** `infrastructure/database/repositories/ticket_repository.py`

**–ú–µ—Ç–æ–¥—ã –¥–ª—è —Ç–∏–∫–µ—Ç–æ–≤:**
- `create()` - —Å–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç
- `get_by_id()` - –ø–æ–ª—É—á–∏—Ç—å –ø–æ ID
- `get_user_tickets()` - —Ç–∏–∫–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `get_all_tickets()` - –≤—Å–µ —Ç–∏–∫–µ—Ç—ã (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
- `update_status()` - –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
- `assign_to()` - –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω—É
- `count_by_status()` - –ø–æ–¥—Å—á—ë—Ç –ø–æ —Å—Ç–∞—Ç—É—Å—É
- `count_by_priority()` - –ø–æ–¥—Å—á—ë—Ç –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
- `get_stats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–ú–µ—Ç–æ–¥—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π:**
- `add_message()` - –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
- `get_messages()` - –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `get_ticket_with_messages()` - —Ç–∏–∫–µ—Ç —Å–æ –≤—Å–µ–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

### 3. TicketService
**–§–∞–π–ª:** `domain/services/ticket_service.py`

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞–º–∏:**
- `create_ticket()` - —Å–æ–∑–¥–∞—Ç—å —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- `get_ticket()` - –ø–æ–ª—É—á–∏—Ç—å —Ç–∏–∫–µ—Ç
- `get_ticket_with_messages()` - —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- `get_user_tickets()` - —Ç–∏–∫–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `get_all_tickets()` - –≤—Å–µ (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
- `close_ticket()` - –∑–∞–∫—Ä—ã—Ç—å
- `reopen_ticket()` - –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å
- `assign_ticket()` - –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω—É

**–°–æ–æ–±—â–µ–Ω–∏—è:**
- `add_message()` - –¥–æ–±–∞–≤–∏—Ç—å —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- `get_messages()` - –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
- `get_stats()` - –ø–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `count_open_tickets()` - –æ—Ç–∫—Ä—ã—Ç—ã–µ
- `count_high_priority_tickets()` - –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- `can_user_access_ticket()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞

### 4. TicketHandler (FSM)
**–§–∞–π–ª:** `application/handlers/tickets/ticket_handler.py`

**FSM —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–∞ (4 —à–∞–≥–∞):**
1. –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (general, technical, suggestion, complaint)
2. –í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ (10-1000 —Å–∏–º–≤–æ–ª–æ–≤)
3. –í—ã–±–æ—Ä –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (low, medium, high)
4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

**–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–∏–∫–µ—Ç–æ–≤:**
- –°–ø–∏—Å–æ–∫ —Å–≤–æ–∏—Ö —Ç–∏–∫–µ—Ç–æ–≤
- –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–∫–µ—Ç–∞
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
- –ó–∞–∫—Ä—ã—Ç–∏–µ —Ç–∏–∫–µ—Ç–∞

**–ú–µ–Ω—é:**
- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ç–∏–∫–µ—Ç–æ–≤
- –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç
- –ú–æ–∏ —Ç–∏–∫–µ—Ç—ã

### 5. AdminTicketHandler
**–§–∞–π–ª:** `application/handlers/tickets/admin_ticket_handler.py`

**–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:**
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤
- –§–∏–ª—å—Ç—Ä—ã (–æ—Ç–∫—Ä—ã—Ç—ã–µ, –≤ —Ä–∞–±–æ—Ç–µ, –∑–∞–∫—Ä—ã—Ç—ã–µ, –≤—Å–µ)
- –°–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä –ª—é–±–æ–≥–æ —Ç–∏–∫–µ—Ç–∞
- –í–∑—è—Ç—å —Ç–∏–∫–µ—Ç –≤ —Ä–∞–±–æ—Ç—É (assign)
- –ó–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:**
- `@require_permission(Permission.VIEW_TICKETS)` - –ø—Ä–æ—Å–º–æ—Ç—Ä
- `@require_permission(Permission.ASSIGN_TICKETS)` - –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
- `@require_permission(Permission.CLOSE_TICKETS)` - –∑–∞–∫—Ä—ã—Ç–∏–µ

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤:** 5  
**–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~900  
**–ö–∞—Ç–µ–≥–æ—Ä–∏–π:** 4  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤:** 3  
**–°—Ç–∞—Ç—É—Å–æ–≤:** 3  
**FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π:** 4  
**Handlers:** 2  

---

## üé´ –°–∏—Å—Ç–µ–º–∞ —Ç–∏–∫–µ—Ç–æ–≤

### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
- üìã –û–±—â–∏–π –≤–æ–ø—Ä–æ—Å
- üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞
- üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
- ‚ö†Ô∏è –ñ–∞–ª–æ–±–∞

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
- üü¢ –ù–∏–∑–∫–∏–π
- üü° –°—Ä–µ–¥–Ω–∏–π
- üî¥ –í—ã—Å–æ–∫–∏–π

### –°—Ç–∞—Ç—É—Å—ã
- üÜï –û—Ç–∫—Ä—ã—Ç (open)
- üîÑ –í —Ä–∞–±–æ—Ç–µ (in_progress)
- ‚úÖ –ó–∞–∫—Ä—ã—Ç (closed)

### –ü—Ä–æ—Ü–µ—Å—Å
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç —Ç–∏–∫–µ—Ç (FSM 4 —à–∞–≥–∞)
2. –¢–∏–∫–µ—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
3. –ê–¥–º–∏–Ω –±–µ—Ä—ë—Ç –≤ —Ä–∞–±–æ—Ç—É (assign)
4. –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
5. –ê–¥–º–∏–Ω –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Ç–∏–∫–µ—Ç

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
```bash
python main_v3.py
```

### 2. –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
```
/tickets - –º–µ–Ω—é —Ç–∏–∫–µ—Ç–æ–≤
–í—ã–±—Ä–∞—Ç—å "‚ûï –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç"

–®–∞–≥ 1: –í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, "üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞")
–®–∞–≥ 2: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–º–∞–Ω–¥–∞ /profile")
–®–∞–≥ 3: –í—ã–±—Ä–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, "üü° –°—Ä–µ–¥–Ω–∏–π")
–®–∞–≥ 4: –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å

–†–µ–∑—É–ª—å—Ç–∞—Ç: –¢–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω, –ø–æ–∫–∞–∑–∞–Ω –Ω–æ–º–µ—Ä
```

### 3. –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∏–∫–µ—Ç—ã (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
```
/tickets
–í—ã–±—Ä–∞—Ç—å "üìã –ú–æ–∏ —Ç–∏–∫–µ—Ç—ã"
–í—ã–±—Ä–∞—Ç—å —Ç–∏–∫–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞
–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏
–ó–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
```

### 4. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ç–∏–∫–µ—Ç–æ–≤
```
/admin
–í—ã–±—Ä–∞—Ç—å "üé´ –¢–∏–∫–µ—Ç—ã" (–µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞)

–ò–ª–∏ —á–µ—Ä–µ–∑ callback:
admin_tickets

–†–µ–∑—É–ª—å—Ç–∞—Ç: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤
```

### 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞–º–∏ (–∞–¥–º–∏–Ω)
```
–í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:
–í—ã–±—Ä–∞—Ç—å "üÜï –û—Ç–∫—Ä—ã—Ç—ã–µ"
–í—ã–±—Ä–∞—Ç—å —Ç–∏–∫–µ—Ç
–ù–∞–∂–∞—Ç—å "‚úã –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É"
–ù–∞–∂–∞—Ç—å "‚úÖ –ó–∞–∫—Ä—ã—Ç—å"

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
domain/
  models/
    ticket.py                  # –ú–æ–¥–µ–ª–∏ —Ç–∏–∫–µ—Ç–æ–≤
  services/
    ticket_service.py          # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤

infrastructure/
  database/
    repositories/
      ticket_repository.py     # Repository –¥–ª—è —Ç–∏–∫–µ—Ç–æ–≤

application/
  handlers/
    tickets/
      __init__.py
      ticket_handler.py        # FSM —Å–æ–∑–¥–∞–Ω–∏—è, –ø—Ä–æ—Å–º–æ—Ç—Ä
      admin_ticket_handler.py  # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç

- [x] –°–æ–∑–¥–∞—Ç—å Ticket, TicketMessage, TicketStats –º–æ–¥–µ–ª–∏
- [x] –°–æ–∑–¥–∞—Ç—å TicketRepository
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å TicketService
- [x] –°–æ–∑–¥–∞—Ç—å FSM –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–∞ (4 —à–∞–≥–∞)
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ —Ç–∏–∫–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- [x] –°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ç–∏–∫–µ—Ç–æ–≤
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã (–æ—Ç–∫—Ä—ã—Ç—ã–µ, –≤ —Ä–∞–±–æ—Ç–µ, –∑–∞–∫—Ä—ã—Ç—ã–µ)
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ –∞–¥–º–∏–Ω—É
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ —Ç–∏–∫–µ—Ç–∞ –∞–¥–º–∏–Ω–æ–º
- [x] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- [x] –°–æ–∑–¥–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–∏–∫–µ—Ç–æ–≤
- [x] –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main_v3.py
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å TicketHandler
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å AdminTicketHandler
- [ ] –î–æ–±–∞–≤–∏—Ç—å ConversationHandler –¥–ª—è FSM
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /tickets
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–≤ –æ –Ω–æ–≤–æ–º —Ç–∏–∫–µ—Ç–µ
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± –æ—Ç–≤–µ—Ç–µ –∞–¥–º–∏–Ω–∞
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Ç–∏–∫–µ—Ç–∞

---

**–î–∞—Ç–∞:** 08.02.2026  
**–í–µ—Ä—Å–∏—è:** v3.0  
**–≠—Ç–∞–ø:** 4 (–ß–∞—Å—Ç—å 2) –∏–∑ 5  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –¢–∏–∫–µ—Ç—ã –≥–æ—Ç–æ–≤—ã  
**–ü—Ä–æ–≥—Ä–µ—Å—Å:** 80% (4 –∏–∑ 5 —ç—Ç–∞–ø–æ–≤)
