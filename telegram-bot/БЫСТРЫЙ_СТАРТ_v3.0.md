# üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ v2.1 ‚Üí v3.0

## –ß—Ç–æ –¥–µ–ª–∞–µ–º?
–ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—ã–π –±–æ—Ç –≤ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É —Å Clean Architecture.

## –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–î–µ–Ω—å 1)

### 1.1 –°–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É
```bash
cd TTFD/telegram-bot
git checkout -b feature/v3.0-refactoring
```

### 1.2 –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ requirements.txt:
asyncpg==0.29.0
redis==5.0.1
alembic==1.13.0
pydantic==2.5.0
python-dotenv==1.0.0
```

### 1.3 –ù–∞—Å—Ç—Ä–æ–∏—Ç—å PostgreSQL (–ª–æ–∫–∞–ª—å–Ω–æ)
```bash
# Windows (—á–µ—Ä–µ–∑ Docker)
docker run --name ttfd-postgres -e POSTGRES_PASSWORD=password -e POSTGRES_DB=ttfd -p 5432:5432 -d postgres:15

# –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PostgreSQL –Ω–∞–ø—Ä—è–º—É—é
```

### 1.4 –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis (–ª–æ–∫–∞–ª—å–Ω–æ)
```bash
docker run --name ttfd-redis -p 6379:6379 -d redis:7-alpine
```

### 1.5 –û–±–Ω–æ–≤–∏—Ç—å .env
```env
# Telegram
TELEGRAM_BOT_TOKEN=your_token
TELEGRAM_ADMIN_IDS=123456789

# Database
DATABASE_URL=postgresql://postgres:password@localhost:5432/ttfd

# Redis
REDIS_URL=redis://localhost:6379

# AI (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
OPENAI_API_KEY=your_key
```

---

## –≠—Ç–∞–ø 2: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–î–µ–Ω—å 2-3)

### 2.1 –°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥–∏
```bash
mkdir -p core domain/models domain/services infrastructure/database/repositories application/handlers/user application/handlers/games application/handlers/support presentation/keyboards presentation/messages tests
```

### 2.2 –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–µ –º–æ–¥–µ–ª–∏
**domain/models/user.py:**
```python
from dataclasses import dataclass
from datetime import datetime
from typing import Optional

@dataclass
class User:
    id: int
    telegram_id: str
    username: str
    first_name: str
    xp: int
    coins: int
    rank_id: int
    role: str
    created_at: datetime
    last_active: datetime
    
    @classmethod
    def from_db_row(cls, row):
        return cls(
            id=row['id'],
            telegram_id=row['telegram_id'],
            username=row['username'],
            first_name=row['first_name'],
            xp=row['xp'],
            coins=row['coins'],
            rank_id=row['rank_id'],
            role=row['role'],
            created_at=row['created_at'],
            last_active=row['last_active']
        )
```

### 2.3 –°–æ–∑–¥–∞—Ç—å repository
**infrastructure/database/repositories/user_repository.py:**
```python
import asyncpg
from typing import Optional
from domain.models.user import User

class UserRepository:
    def __init__(self, pool: asyncpg.Pool):
        self.pool = pool
    
    async def get_by_telegram_id(self, telegram_id: str) -> Optional[User]:
        async with self.pool.acquire() as conn:
            row = await conn.fetchrow(
                "SELECT * FROM users WHERE telegram_id = $1",
                telegram_id
            )
            return User.from_db_row(row) if row else None
    
    async def create(self, telegram_id: str, username: str, first_name: str) -> User:
        async with self.pool.acquire() as conn:
            row = await conn.fetchrow(
                """
                INSERT INTO users (telegram_id, username, first_name)
                VALUES ($1, $2, $3)
                RETURNING *
                """,
                telegram_id, username, first_name
            )
            return User.from_db_row(row)
```

### 2.4 –°–æ–∑–¥–∞—Ç—å service
**domain/services/user_service.py:**
```python
from infrastructure.database.repositories.user_repository import UserRepository

class UserService:
    def __init__(self, user_repo: UserRepository):
        self.user_repo = user_repo
    
    async def get_or_create_user(self, telegram_id: str, username: str, first_name: str):
        user = await self.user_repo.get_by_telegram_id(telegram_id)
        if not user:
            user = await self.user_repo.create(telegram_id, username, first_name)
        return user
```

---

## –≠—Ç–∞–ø 3: –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (–î–µ–Ω—å 4)

### 3.1 –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É PostgreSQL
**migrations/001_initial.sql:**
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    telegram_id VARCHAR(50) UNIQUE NOT NULL,
    username VARCHAR(100),
    first_name VARCHAR(100),
    xp INTEGER DEFAULT 0,
    coins INTEGER DEFAULT 0,
    rank_id INTEGER DEFAULT 1,
    role VARCHAR(20) DEFAULT 'user',
    created_at TIMESTAMP DEFAULT NOW(),
    last_active TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_users_telegram_id ON users(telegram_id);
CREATE INDEX idx_users_xp ON users(xp DESC);
```

### 3.2 –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ JSON ‚Üí PostgreSQL
**scripts/migrate_json_to_postgres.py:**
```python
import json
import asyncio
import asyncpg

async def migrate():
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ PostgreSQL
    conn = await asyncpg.connect('postgresql://postgres:password@localhost:5432/ttfd')
    
    # –ß–∏—Ç–∞–µ–º JSON
    with open('data/user_data.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    # –ú–∏–≥—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    for telegram_id, user_data in data['users'].items():
        await conn.execute(
            """
            INSERT INTO users (telegram_id, username, first_name, xp, coins, rank_id, created_at)
            VALUES ($1, $2, $3, $4, $5, $6, $7)
            ON CONFLICT (telegram_id) DO NOTHING
            """,
            telegram_id,
            user_data['username'],
            user_data['first_name'],
            user_data['xp'],
            user_data['coins'],
            user_data['rank_id'],
            user_data['created_at']
        )
    
    print(f"‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(data['users'])} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    await conn.close()

if __name__ == '__main__':
    asyncio.run(migrate())
```

---

## –≠—Ç–∞–ø 4: –û–±–Ω–æ–≤–∏—Ç—å main.py (–î–µ–Ω—å 5)

**main.py (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è):**
```python
import asyncio
import asyncpg
from telegram.ext import Application
from core.config import Config
from infrastructure.database.repositories.user_repository import UserRepository
from domain.services.user_service import UserService
from application.handlers.user.profile_handler import ProfileHandler

async def main():
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥
    config = Config.from_env()
    
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ PostgreSQL
    db_pool = await asyncpg.create_pool(config.database_url)
    
    # –°–æ–∑–¥–∞—ë–º repositories
    user_repo = UserRepository(db_pool)
    
    # –°–æ–∑–¥–∞—ë–º services
    user_service = UserService(user_repo)
    
    # –°–æ–∑–¥–∞—ë–º handlers
    profile_handler = ProfileHandler(user_service)
    
    # –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    app = Application.builder().token(config.telegram_bot_token).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º handlers
    app.add_handler(CommandHandler("profile", profile_handler.handle_profile_command))
    
    print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (v3.0)")
    await app.run_polling()

if __name__ == '__main__':
    asyncio.run(main())
```

---

## –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–î–µ–Ω—å 6-7)

### 5.1 Unit —Ç–µ—Å—Ç—ã
**tests/test_user_service.py:**
```python
import pytest
from unittest.mock import AsyncMock
from domain.services.user_service import UserService

@pytest.mark.asyncio
async def test_get_or_create_user():
    # Arrange
    user_repo = AsyncMock()
    user_repo.get_by_telegram_id.return_value = None
    user_service = UserService(user_repo)
    
    # Act
    user = await user_service.get_or_create_user("123", "test", "Test")
    
    # Assert
    user_repo.create.assert_called_once()
```

### 5.2 –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
```bash
pytest tests/ -v
```

---

## –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–∞
- [ ] –õ–æ–∫–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å PostgreSQL
- [ ] –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø JSON
- [ ] –û–±–Ω–æ–≤–ª—ë–Ω requirements.txt
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## –î–µ–ø–ª–æ–π –Ω–∞ Railway

1. –î–æ–±–∞–≤–∏—Ç—å PostgreSQL addon –≤ Railway
2. –î–æ–±–∞–≤–∏—Ç—å Redis addon –≤ Railway
3. –û–±–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
   - `DATABASE_URL` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ PostgreSQL addon)
   - `REDIS_URL` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ Redis addon)
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ Railway
5. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é

---

## –ß—Ç–æ –¥–∞–ª—å—à–µ?

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ v3.0:
- –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis)
- –î–æ–±–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É —Ä–æ–ª–µ–π
- –î–æ–±–∞–≤–∏—Ç—å –º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω—É—é —ç–∫–æ–Ω–æ–º–∏–∫—É
- –î–æ–±–∞–≤–∏—Ç—å PvP –∏–≥—Ä—ã

–ü–æ–ª–Ω—ã–π roadmap: `PLATFORM_EVOLUTION_ROADMAP.md`
