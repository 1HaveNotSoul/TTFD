# ‚úÖ –ì–û–¢–û–í–û: –≠—Ç–∞–ø 3 - –°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π –∏ Permissions

## üéØ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ú–æ–¥–µ–ª–∏ Permission –∏ Role
**–§–∞–π–ª:** `domain/models/permission.py`

#### Permission (27 –ø—Ä–∞–≤)
```python
# –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∞
VIEW_PROFILE, EDIT_PROFILE, USE_SHOP, PLAY_GAMES, CREATE_TICKETS

# VIP –ø—Ä–∞–≤–∞
VIP_SHOP_ACCESS, VIP_DAILY_BONUS, SKIP_COOLDOWNS, VIP_BADGE

# –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä
VIEW_TICKETS, ASSIGN_TICKETS, CLOSE_TICKETS, MUTE_USERS, WARN_USERS

# –ê–¥–º–∏–Ω
MANAGE_USERS, MANAGE_ECONOMY, MANAGE_GAMES, VIEW_ANALYTICS, BROADCAST, BAN_USERS

# –í–ª–∞–¥–µ–ª–µ—Ü
MANAGE_ADMINS, MANAGE_ROLES, SYSTEM_CONFIG
```

#### Role (5 —Ä–æ–ª–µ–π)
- **USER** - –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- **VIP** - –ø—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- **MODERATOR** - –º–æ–¥–µ—Ä–∞—Ç–æ—Ä
- **ADMIN** - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
- **OWNER** - –≤–ª–∞–¥–µ–ª–µ—Ü

#### –ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤
–ö–∞–∂–¥–∞—è —Ä–æ–ª—å –Ω–∞—Å–ª–µ–¥—É–µ—Ç –ø—Ä–∞–≤–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π + –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–≤–æ–∏:
- USER: 5 –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∞–≤
- VIP: USER + 4 VIP –ø—Ä–∞–≤–∞
- MODERATOR: VIP + 5 –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–∞–≤
- ADMIN: MODERATOR + 6 –∞–¥–º–∏–Ω—Å–∫–∏—Ö –ø—Ä–∞–≤
- OWNER: –≤—Å–µ 27 –ø—Ä–∞–≤

---

### 2. PermissionService
**–§–∞–π–ª:** `domain/services/permission_service.py`

#### –ú–µ—Ç–æ–¥—ã
- `check_permission(user, permission)` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–æ
- `get_user_permissions(user)` - –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã
```python
@PermissionService.require_permission(Permission.MANAGE_USERS)
async def ban_user(self, update, context):
    # –¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø—Ä–∞–≤–æ–º MANAGE_USERS
    ...

@PermissionService.require_role(Role.ADMIN)
async def admin_panel(self, update, context):
    # –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –∏ –≤—ã—à–µ
    ...
```

**–§–∏—á–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º
- –ö—Ä–∞—Å–∏–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –ò–µ—Ä–∞—Ä—Ö–∏—è —Ä–æ–ª–µ–π (ADMIN –º–æ–∂–µ—Ç –≤—Å—ë —á—Ç–æ MODERATOR)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å UserService

---

### 3. AdminHandler
**–§–∞–π–ª:** `application/handlers/admin/admin_handler.py`

#### –ö–æ–º–∞–Ω–¥—ã

**`/admin`** (—Ç—Ä–µ–±—É–µ—Ç Role.ADMIN)
- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–æ–ª–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥

**`/admin_stats`** (—Ç—Ä–µ–±—É–µ—Ç Permission.VIEW_ANALYTICS)
- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –¢–æ–ø-3 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ XP

**`/setrole <telegram_id> <role>`** (—Ç—Ä–µ–±—É–µ—Ç Permission.MANAGE_USERS)
- –ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–æ–ª–∏
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î

**`/broadcast <—Ç–µ–∫—Å—Ç>`** (—Ç—Ä–µ–±—É–µ—Ç Permission.BROADCAST)
- –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –°—á—ë—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É–¥–∞—á–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

---

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main_v3.py

```python
# –ò–º–ø–æ—Ä—Ç
from domain.services.permission_service import PermissionService
from application.handlers.admin.admin_handler import AdminHandler

# –°–æ–∑–¥–∞–Ω–∏–µ handler
admin_handler = AdminHandler(user_service)

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
app.add_handler(CommandHandler("admin", admin_handler.handle_admin_command))
app.add_handler(CommandHandler("admin_stats", admin_handler.handle_stats_command))
app.add_handler(CommandHandler("setrole", admin_handler.handle_set_role_command))
app.add_handler(CommandHandler("broadcast", admin_handler.handle_broadcast_command))
```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. Enum-based Permissions
–ò—Å–ø–æ–ª—å–∑—É–µ–º Enum –¥–ª—è —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
```python
Permission.MANAGE_USERS  # –ù–µ "manage_users" —Å—Ç—Ä–æ–∫–æ–π
```

### 2. –ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ `ROLE_PERMISSIONS`:
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–∞–≤–∞
- –õ–µ–≥–∫–æ –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∞ —Ä–æ–ª–µ–π
- –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã

### 3. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
–î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
```python
@require_permission(Permission.BAN_USERS)
async def ban_user(...):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è
```

### 4. –ò–µ—Ä–∞—Ä—Ö–∏—è —Ä–æ–ª–µ–π
–†–æ–ª–∏ —É–ø–æ—Ä—è–¥–æ—á–µ–Ω—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É:
```python
USER < VIP < MODERATOR < ADMIN < OWNER
```

ADMIN –º–æ–∂–µ—Ç –≤—Å—ë —á—Ç–æ MODERATOR + —Å–≤–æ–∏ –ø—Ä–∞–≤–∞.

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —ç—Ç–∞–ø–∞ 3

**–°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤:** 3  
**–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~400  
**–ü—Ä–∞–≤:** 27  
**–†–æ–ª–µ–π:** 5  
**–ö–æ–º–∞–Ω–¥:** 4  
**–î–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤:** 2  

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
```bash
cd TTFD/telegram-bot
python main_v3.py
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
/admin
# –î–æ–ª–∂–Ω–æ: ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤
```

### 3. –ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –Ω–∞ admin
```sql
UPDATE users SET role = 'admin' WHERE telegram_id = '—Ç–≤–æ–π_id';
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã
```
/admin
# –î–æ–ª–∂–Ω–æ: üîß –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

/admin_stats
# –î–æ–ª–∂–Ω–æ: üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

/setrole 123456789 vip
# –î–æ–ª–∂–Ω–æ: ‚úÖ –†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞

/broadcast –ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º!
# –î–æ–ª–∂–Ω–æ: üì¢ –ù–∞—á–∏–Ω–∞—é —Ä–∞—Å—Å—ã–ª–∫—É...
```

---

## üéØ –ß—Ç–æ –¥–∞–ª—å—à–µ (–≠—Ç–∞–ø 4)

### –ò–≥—Ä—ã
- [ ] Game models (GuessGame, QuizGame, SpinGame)
- [ ] GameRepository
- [ ] GameService
- [ ] Handlers –¥–ª—è –∏–≥—Ä (/guess, /quiz, /spin)
- [ ] –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–±–µ–¥/–ø–æ—Ä–∞–∂–µ–Ω–∏–π

### –¢–∏–∫–µ—Ç—ã
- [ ] Ticket models
- [ ] TicketRepository
- [ ] TicketService
- [ ] FSM –¥–ª—è —Ç–∏–∫–µ—Ç–æ–≤
- [ ] –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤

---

## üìö –§–∞–π–ª—ã —ç—Ç–∞–ø–∞ 3

```
domain/
  models/
    permission.py          # Permission, Role, –º–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∞–≤
  services/
    permission_service.py  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤, –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã

application/
  handlers/
    admin/
      admin_handler.py     # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

main_v3.py                 # –û–±–Ω–æ–≤–ª—ë–Ω (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è AdminHandler)
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç

- [x] –°–æ–∑–¥–∞—Ç—å Permission enum (27 –ø—Ä–∞–≤)
- [x] –°–æ–∑–¥–∞—Ç—å Role enum (5 —Ä–æ–ª–µ–π)
- [x] –°–æ–∑–¥–∞—Ç—å –º–∞—Ç—Ä–∏—Ü—É –ø—Ä–∞–≤ ROLE_PERMISSIONS
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å PermissionService
- [x] –°–æ–∑–¥–∞—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã @require_permission –∏ @require_role
- [x] –°–æ–∑–¥–∞—Ç—å AdminHandler
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å /admin –∫–æ–º–∞–Ω–¥—É
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å /admin_stats –∫–æ–º–∞–Ω–¥—É
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å /setrole –∫–æ–º–∞–Ω–¥—É
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å /broadcast –∫–æ–º–∞–Ω–¥—É
- [x] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å AdminHandler –≤ main_v3.py
- [x] –û–±–Ω–æ–≤–∏—Ç—å /help —Å –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥–∞–º–∏
- [x] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã count() –∏ get_all() –≤ UserRepository (—É–∂–µ –±—ã–ª–∏)
- [x] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤
- [x] –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

**–î–∞—Ç–∞:** 08.02.2026  
**–í–µ—Ä—Å–∏—è:** v3.0  
**–≠—Ç–∞–ø:** 3 –∏–∑ 5  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω  
**–ü—Ä–æ–≥—Ä–µ—Å—Å:** 60% (3 –∏–∑ 5 —ç—Ç–∞–ø–æ–≤)
