# üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏: –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:** –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ (–≠—Ç–∞–ø 1)  
**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ Discord Bot

---

## ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î (5 –º–∏–Ω—É—Ç)
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ PostgreSQL
psql $DATABASE_URL

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
\i infrastructure/database/migrations/006_bidirectional_sync.sql

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
\dt sync_*
SELECT COUNT(*) FROM rank_role_mappings;  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 20
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å Discord role IDs (10 –º–∏–Ω—É—Ç)
```sql
-- –í Discord: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ ‚Üí –†–æ–ª–∏ ‚Üí –ü–ö–ú ‚Üí –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID

-- –û–±–Ω–æ–≤–∏—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–Ω–≥
UPDATE rank_role_mappings SET discord_role_id = '–†–ï–ê–õ–¨–ù–´–ô_ID' WHERE rank_id = 1;
UPDATE rank_role_mappings SET discord_role_id = '–†–ï–ê–õ–¨–ù–´–ô_ID' WHERE rank_id = 2;
-- ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –≤—Å–µ—Ö 20 —Ä–∞–Ω–≥–æ–≤
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ main_v3.py (15 –º–∏–Ω—É—Ç)
```python
# –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã
from infrastructure.database.repositories.sync_repository import SyncRepository
from domain.services.sync_service import SyncService
from application.jobs.sync_worker import SyncWorker, ReconcileWorker, CleanupWorker

# –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –¥—Ä—É–≥–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
sync_repo = SyncRepository(db_connection.get_pool())

# –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
sync_service = SyncService(sync_repo, user_repo, discord_repo)

# –û–±–Ω–æ–≤–∏—Ç—å GameService (–¥–æ–±–∞–≤–∏—Ç—å sync_service)
game_service = GameService(
    game_repo, user_repo,
    season_service, achievement_service,
    sync_service  # NEW
)

# –û–±–Ω–æ–≤–∏—Ç—å UserService (–¥–æ–±–∞–≤–∏—Ç—å sync_service)
user_service = UserService(
    user_repo, cache,
    sync_service  # NEW
)

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä—ã (–ø–æ—Å–ª–µ "–ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á...")
sync_worker = SyncWorker(sync_service, interval_seconds=5)
reconcile_worker = ReconcileWorker(sync_service, interval_minutes=15)
cleanup_worker = CleanupWorker(sync_service, interval_hours=24)

asyncio.create_task(sync_worker.start())
asyncio.create_task(reconcile_worker.start())
asyncio.create_task(cleanup_worker.start())

# –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–≤–æ–¥ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
print("   ‚Ä¢ Bidirectional Sync (Telegram ‚Üî Discord)")
```

### 4. –û–±–Ω–æ–≤–∏—Ç—å GameService (10 –º–∏–Ω—É—Ç)
```python
# –í domain/services/game_service.py

# –î–æ–±–∞–≤–∏—Ç—å –≤ __init__
def __init__(
    self,
    game_repo: GameRepository,
    user_repo: UserRepository,
    season_service=None,
    achievement_service=None,
    sync_service=None  # NEW
):
    self.game_repo = game_repo
    self.user_repo = user_repo
    self.season_service = season_service
    self.achievement_service = achievement_service
    self.sync_service = sync_service  # NEW

# –í check_guess() –ø–æ—Å–ª–µ update_xp
if self.sync_service:
    await self.sync_service.create_xp_change_event(
        user_id=user.id,
        delta_xp=reward_xp,
        source="telegram",
        reason="game_guess",
        entity_id=str(session.id)
    )

# –í check_quiz_answer() –ø–æ—Å–ª–µ update_xp
if self.sync_service:
    await self.sync_service.create_xp_change_event(
        user_id=user.id,
        delta_xp=reward_xp,
        source="telegram",
        reason="game_quiz",
        entity_id=str(session.id)
    )

# –í spin_wheel() –ø–æ—Å–ª–µ update_xp
if self.sync_service:
    await self.sync_service.create_xp_change_event(
        user_id=user.id,
        delta_xp=reward_xp,
        source="telegram",
        reason="daily_spin",
        entity_id=f"spin_{int(datetime.now().timestamp())}"
    )
```

### 5. –û–±–Ω–æ–≤–∏—Ç—å UserService (5 –º–∏–Ω—É—Ç)
```python
# –í domain/services/user_service.py

# –î–æ–±–∞–≤–∏—Ç—å –≤ __init__
def __init__(
    self,
    user_repo: UserRepository,
    cache,
    sync_service=None  # NEW
):
    self.user_repo = user_repo
    self.cache = cache
    self.sync_service = sync_service  # NEW

# –í claim_daily() –ø–æ—Å–ª–µ update_xp
if self.sync_service:
    await self.sync_service.create_xp_change_event(
        user_id=user.id,
        delta_xp=100,
        source="telegram",
        reason="daily_reward"
    )
    
    await self.sync_service.create_balance_change_event(
        user_id=user.id,
        delta_balance=50,
        source="telegram",
        reason="daily_reward"
    )
```

### 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å (10 –º–∏–Ω—É—Ç)
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
python main_v3.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å:
# "üöÄ SyncWorker –∑–∞–ø—É—â–µ–Ω: interval=5s, batch_size=100"
# "üöÄ ReconcileWorker –∑–∞–ø—É—â–µ–Ω: interval=15m, batch_size=100"
# "üöÄ CleanupWorker –∑–∞–ø—É—â–µ–Ω: interval=24h, retention=30d"

# –°—ã–≥—Ä–∞—Ç—å –≤ –∏–≥—Ä—É
/games ‚Üí –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –≤ –ë–î
psql $DATABASE_URL
SELECT * FROM sync_events ORDER BY created_at DESC LIMIT 5;

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
SELECT * FROM transactions ORDER BY created_at DESC LIMIT 5;

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É (—á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥)
SELECT status, COUNT(*) FROM sync_events GROUP BY status;
```

---

## üìã –ü–æ–ª–Ω—ã–π –ø–ª–∞–Ω (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (1 —á–∞—Å)
- [x] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
- [x] –û–±–Ω–æ–≤–∏—Ç—å Discord role IDs
- [x] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ main_v3.py
- [x] –û–±–Ω–æ–≤–∏—Ç—å GameService
- [x] –û–±–Ω–æ–≤–∏—Ç—å UserService
- [x] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: Discord Bot (3-4 —á–∞—Å–∞)
- [ ] –°–æ–∑–¥–∞—Ç—å Discord Bot –ø—Ä–æ–µ–∫—Ç
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã (/link, /unlink, /profile, /sync)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π (voice, messages)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å SyncService
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É –∞–∫–∫–∞—É–Ω—Ç–æ–≤

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (2-3 —á–∞—Å–∞)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Discord ‚Üí Telegram —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é XP
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–º–µ–Ω—É —Ä–æ–ª–µ–π —Ä–∞–Ω–≥–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—ã–¥–∞—á—É —Ä–æ–ª–µ–π –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—é—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–¥–º–∏–Ω–∫–∞ (1-2 —á–∞—Å–∞)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- [ ] –°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞–ª–µ—Ä—Ç—ã
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

---

## üéØ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π –≤–∞—Ä–∏–∞–Ω—Ç (MVP)

–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–±–æ—Ç–∞—é—â—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é **—Å–µ–≥–æ–¥–Ω—è**, –Ω—É–∂–Ω–æ:

1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (5 –º–∏–Ω)
2. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ main_v3.py (15 –º–∏–Ω)
3. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å GameService (10 –º–∏–Ω)
4. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π (10 –º–∏–Ω)

**–ò—Ç–æ–≥–æ: 40 –º–∏–Ω—É—Ç**

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —É —Ç–µ–±—è –±—É–¥–µ—Ç:
- ‚úÖ –°–æ–±—ã—Ç–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ –∏–≥—Ä–∞—Ö
- ‚úÖ SyncWorker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å
- ‚úÖ ReconcileWorker –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

**–ß—Ç–æ –ù–ï –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å:**
- ‚ùå Discord Bot (–Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ)
- ‚ùå –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Discord ‚Üí Telegram
- ‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–º–µ–Ω–∞ —Ä–æ–ª–µ–π

---

## üîß –°–æ–∑–¥–∞–Ω–∏–µ Discord Bot (–æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
TTFD/discord-bot/
‚îú‚îÄ‚îÄ main.py              # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª Discord –±–æ—Ç–∞
‚îú‚îÄ‚îÄ commands.py          # –ö–æ–º–∞–Ω–¥—ã /link, /unlink, /profile
‚îú‚îÄ‚îÄ events.py            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ on_voice_state_update, on_message
‚îú‚îÄ‚îÄ sync_client.py       # –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
‚îú‚îÄ‚îÄ config.py            # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ requirements.txt     # discord.py, asyncpg, etc
‚îî‚îÄ‚îÄ .env                 # –¢–æ–∫–µ–Ω—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```

### requirements.txt
```
discord.py==2.3.2
asyncpg==0.29.0
python-dotenv==1.0.0
```

### .env
```
DISCORD_BOT_TOKEN=your_discord_bot_token
DISCORD_GUILD_ID=your_guild_id
DATABASE_URL=postgresql://...
```

### main.py (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä)
```python
import discord
from discord.ext import commands
import asyncpg
import os
from dotenv import load_dotenv

load_dotenv()

intents = discord.Intents.default()
intents.message_content = True
intents.voice_states = True
intents.members = True

bot = commands.Bot(command_prefix='/', intents=intents)

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
pool = None

@bot.event
async def on_ready():
    global pool
    pool = await asyncpg.create_pool(os.getenv('DATABASE_URL'))
    print(f'‚úÖ Discord Bot –∑–∞–ø—É—â–µ–Ω: {bot.user}')
    await bot.tree.sync()

@bot.tree.command(name="link", description="–ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram –∞–∫–∫–∞—É–Ω—Ç")
async def link(interaction: discord.Interaction, code: str):
    # TODO: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –∏ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
    await interaction.response.send_message(f"–ö–æ–¥: {code}")

@bot.tree.command(name="profile", description="–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å")
async def profile(interaction: discord.Interaction):
    # TODO: –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
    await interaction.response.send_message("–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å")

bot.run(os.getenv('DISCORD_BOT_TOKEN'))
```

---

## üí° –°–æ–≤–µ—Ç—ã

### –û—Ç–ª–∞–¥–∫–∞ —Å–æ–±—ã—Ç–∏–π
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ SyncService –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logger.setLevel(logging.DEBUG)

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
event = await sync_service.create_xp_change_event(...)
print(f"Event ID: {event.id}")
print(f"Idempotency key: {event.idempotency_key}")

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
await sync_worker.process_now()  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
```sql
-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
SELECT 
    id, event_type, source, status, 
    payload->>'delta_xp' as delta_xp,
    created_at
FROM sync_events 
ORDER BY created_at DESC 
LIMIT 10;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
SELECT status, COUNT(*) 
FROM sync_events 
GROUP BY status;

-- –ü—Ä–æ–≤–∞–ª–∏–≤—à–∏–µ—Å—è —Å–æ–±—ã—Ç–∏—è
SELECT id, event_type, error_message, retries
FROM sync_events
WHERE status = 'failed'
ORDER BY created_at DESC;
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–æ—Ä–∫–µ—Ä–æ–≤
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ main_v3.py –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
async def monitor_sync():
    while True:
        await asyncio.sleep(60)  # –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        stats = await sync_service.get_stats()
        logger.info(
            f"üìä Sync stats: pending={stats['pending']}, "
            f"completed={stats['completed']}, failed={stats['failed']}"
        )

asyncio.create_task(monitor_sync())
```

---

**–ì–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏!** üöÄ

–ù–∞—á–Ω–∏ —Å MVP (40 –º–∏–Ω—É—Ç), –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–ª—è–π Discord Bot –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ.

