# ‚úÖ –ì–û–¢–û–í–û: –≠—Ç–∞–ø 1 - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ v3.0

## üéØ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ (Clean Architecture)

```
telegram-bot/
‚îú‚îÄ‚îÄ core/                      # –Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ config.py             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ exceptions.py         # –ò—Å–∫–ª—é—á–µ–Ω–∏—è
‚îÇ
‚îú‚îÄ‚îÄ domain/                    # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user.py          # User, Rank –º–æ–¥–µ–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îî‚îÄ‚îÄ user_service.py  # UserService
‚îÇ
‚îú‚îÄ‚îÄ infrastructure/           # –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
‚îÇ   ‚îî‚îÄ‚îÄ database/
‚îÇ       ‚îú‚îÄ‚îÄ connection.py    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
‚îÇ       ‚îú‚îÄ‚îÄ repositories/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ user_repository.py
‚îÇ       ‚îî‚îÄ‚îÄ migrations/
‚îÇ           ‚îî‚îÄ‚îÄ 001_initial_schema.sql
‚îÇ
‚îú‚îÄ‚îÄ application/             # Application Layer
‚îÇ   ‚îî‚îÄ‚îÄ handlers/
‚îÇ       ‚îî‚îÄ‚îÄ user/
‚îÇ           ‚îî‚îÄ‚îÄ profile_handler.py
‚îÇ
‚îú‚îÄ‚îÄ presentation/            # UI Layer (–ø–æ–∫–∞ –ø—É—Å—Ç–æ)
‚îú‚îÄ‚îÄ tests/                   # –¢–µ—Å—Ç—ã (–ø–æ–∫–∞ –ø—É—Å—Ç–æ)
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ migrate_json_to_postgres.py
‚îÇ
‚îú‚îÄ‚îÄ main_v3.py              # –ù–æ–≤–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îî‚îÄ‚îÄ requirements.txt        # –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```

### 2. Domain Models

**User model:**
- –ü–æ–ª–Ω–∞—è –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- –ú–µ—Ç–æ–¥—ã `from_db_row()` –∏ `to_dict()`
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –ø–æ–ª–µ–π (xp, coins, rank_id, role, etc.)

**Rank model:**
- 20 —Ä–∞–Ω–≥–æ–≤ TTFD
- –§—É–Ω–∫—Ü–∏–∏ `get_rank_by_id()` –∏ `calculate_rank_by_xp()`

### 3. Repository Pattern

**UserRepository:**
- `get_by_telegram_id()` - –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `create()` - —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `update()` - –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `update_xp()` - –∞—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ XP
- `update_coins()` - –∞—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–Ω–µ—Ç
- `get_leaderboard()` - —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `count()` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 4. Business Logic (Services)

**UserService:**
- `get_or_create_user()` - –ø–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å
- `add_xp()` - –¥–æ–±–∞–≤–∏—Ç—å XP —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–∞–Ω–≥–∞
- `add_coins()` / `remove_coins()` - —Ä–∞–±–æ—Ç–∞ —Å –º–æ–Ω–µ—Ç–∞–º–∏
- `can_claim_daily()` / `claim_daily()` - –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞
- `get_leaderboard()` - —Ç–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
- `get_rank_progress()` - –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–Ω–≥–∞

### 5. Handlers (Application Layer)

**ProfileHandler:**
- –¢–æ–Ω–∫–∏–π —Å–ª–æ–π - —Ç–æ–ª—å–∫–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
- –í—ã–∑—ã–≤–∞–µ—Ç UserService –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 6. Database

**PostgreSQL schema:**
- –¢–∞–±–ª–∏—Ü–∞ `users` —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
- –¢–∞–±–ª–∏—Ü–∞ `transactions` (–∏—Å—Ç–æ—Ä–∏—è)
- –¢–∞–±–ª–∏—Ü–∞ `inventory` (–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å)
- –¢–∞–±–ª–∏—Ü–∞ `game_history` (–∏—Å—Ç–æ—Ä–∏—è –∏–≥—Ä)
- –¢–∞–±–ª–∏—Ü–∞ `tickets` + `ticket_messages`
- –¢–∞–±–ª–∏—Ü–∞ `achievements` + `user_achievements`
- –¢–∞–±–ª–∏—Ü–∞ `global_stats`

**–ú–∏–≥—Ä–∞—Ü–∏—è:**
- SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü
- Python —Å–∫—Ä–∏–ø—Ç –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ JSON ‚Üí PostgreSQL

### 7. Configuration

**Config class:**
- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ .env
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PostgreSQL, Redis, OpenAI

### 8. Dependencies

–û–±–Ω–æ–≤–ª—ë–Ω `requirements.txt`:
- `asyncpg==0.29.0` - PostgreSQL
- `redis==5.0.1` - Redis
- `pydantic==2.5.0` - –í–∞–ª–∏–¥–∞—Ü–∏—è

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

- **–§–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:** 15+
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~1500
- **–°–ª–æ—ë–≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:** 4 (Core, Domain, Infrastructure, Application)
- **–ú–æ–¥–µ–ª–µ–π:** 2 (User, Rank)
- **–°–µ—Ä–≤–∏—Å–æ–≤:** 1 (UserService)
- **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤:** 1 (UserRepository)
- **Handlers:** 1 (ProfileHandler)

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PostgreSQL (Docker –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é)
2. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã: `001_initial_schema.sql`
3. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ: `python scripts/migrate_json_to_postgres.py`
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å: `python main_v3.py`
5. –û—Ç–ø—Ä–∞–≤–∏—Ç—å `/profile` –±–æ—Ç—É

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### 1. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- **Handlers** - —Ç–æ–ª—å–∫–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
- **Services** - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- **Repositories** - —Ä–∞–±–æ—Ç–∞ —Å –ë–î
- **Models** - –¥–∞–Ω–Ω—ã–µ + –≤–∞–ª–∏–¥–∞—Ü–∏—è

### 2. –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å
```python
# –õ–µ–≥–∫–æ –º–æ–∫–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
mock_repo = AsyncMock()
service = UserService(mock_repo)
await service.add_xp("123", 100)
mock_repo.update_xp.assert_called_once()
```

### 3. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
```python
# –û–¥–∏–Ω service –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
user_service = UserService(user_repo)

# Telegram
telegram_handler = ProfileHandler(user_service)

# Web API
@app.get("/users/{telegram_id}")
async def get_user(telegram_id: str):
    return await user_service.get_user(telegram_id)
```

### 4. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ repository
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ handlers
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ services

---

## üöß –ß—Ç–æ –¥–∞–ª—å—à–µ? (–≠—Ç–∞–ø 2)

### –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- [ ] `/daily` - –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞
- [ ] `/leaderboard` - —Ç–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
- [ ] –ò–≥—Ä—ã (guess, quiz, spin)
- [ ] –¢–∏–∫–µ—Ç—ã
- [ ] –ú–∞–≥–∞–∑–∏–Ω
- [ ] –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

### –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis):
- [ ] –ö—ç—à –ø—Ä–æ—Ñ–∏–ª–µ–π (5 –º–∏–Ω)
- [ ] –ö—ç—à –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ (1 –º–∏–Ω)
- [ ] –ö—ç—à –º–∞–≥–∞–∑–∏–Ω–∞ (10 –º–∏–Ω)

### –î–æ–±–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É —Ä–æ–ª–µ–π:
- [ ] Permission enum
- [ ] Role enum
- [ ] PermissionService
- [ ] –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@require_permission`

---

## üìù –ó–∞–º–µ—Ç–∫–∏

- **v2.1 –æ—Å—Ç–∞—ë—Ç—Å—è —Ä–∞–±–æ—á–∏–º** - –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- **main_v3.py** - –Ω–æ–≤–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (–Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç main.py)
- **–ú–∏–≥—Ä–∞—Ü–∏—è –æ–±—Ä–∞—Ç–∏–º–∞** - –¥–∞–Ω–Ω—ã–µ –≤ JSON –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è
- **PostgreSQL –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** - –±–µ–∑ –Ω–µ–≥–æ v3.0 –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è

---

## üéì –ß—Ç–æ –∏–∑—É—á–µ–Ω–æ

1. **Clean Architecture** - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ–∏
2. **Domain-Driven Design** - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ domain
3. **Repository Pattern** - –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –Ω–∞–¥ –ë–î
4. **Dependency Injection** - –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
5. **Async PostgreSQL** - asyncpg

---

## üöÄ –ì–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É!

–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: **–ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É**

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- `PLATFORM_EVOLUTION_ROADMAP.md` - –ø–æ–ª–Ω—ã–π –ø–ª–∞–Ω
- `–ë–´–°–¢–†–´–ô_–°–¢–ê–†–¢_v3.0.md` - –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- `–ó–ê–ü–£–°–ö_v3.0.md` - –∫–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å
- `–ê–†–•–ò–¢–ï–ö–¢–£–†–ê_v3.0_–°–•–ï–ú–ê.md` - —Å—Ö–µ–º—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
