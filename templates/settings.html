<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ - TTFD</title>
    <link rel="stylesheet" href="/static/css/main.css?v=2.0">
    <style>
        .container { max-width: 800px; }
        .header h1 { font-size: 2.5em; }
        .color-picker { display: flex; gap: 10px; align-items: center; }
        .color-picker input[type="color"] {
            width: 60px; height: 40px; border: none; border-radius: 8px; cursor: pointer;
        }
        .profile-link {
            background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;
            text-align: center;
        }
        .profile-link a { color: #667eea; font-weight: bold; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h1>
        </div>
        
        <div class="nav">
            <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="/profile/{{ current_user.username }}">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a>
            <a href="/game">üéÆ –ö–ª–∏–∫–µ—Ä</a>
            <a href="/logout">–í—ã—Ö–æ–¥</a>
        </div>

        <div id="message"></div>

        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="card">
            <h2>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <form id="profileForm">
                <div class="form-group">
                    <label>–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                    <input type="text" id="display_name" value="{{ current_user.display_name }}" required>
                </div>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" value="{{ current_user.email }}" required>
                </div>
                
                <div class="form-group">
                    <label>–õ–æ–≥–∏–Ω (–Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å)</label>
                    <input type="text" value="{{ current_user.username }}" disabled>
                </div>
                
                <div class="form-group">
                    <label>–û —Å–µ–±–µ</label>
                    <textarea id="bio" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ...">{{ current_user.profile.bio }}</textarea>
                </div>
                
                <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>

        <!-- –í–Ω–µ—à–Ω–∏–π –≤–∏–¥ -->
        <div class="card">
            <h2>–í–Ω–µ—à–Ω–∏–π –≤–∏–¥ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            <form id="designForm">
                <div class="form-group">
                    <label>–ê–≤–∞—Ç–∞—Ä–∫–∞</label>
                    <input type="file" id="avatar_file" accept="image/*">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        –ó–∞–≥—Ä—É–∑–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ —Å–≤–æ–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (JPG, PNG, GIF)
                    </small>
                    {% if current_user.profile.avatar_url %}
                    <div style="margin-top: 10px;">
                        <img src="{{ current_user.profile.avatar_url }}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
                    </div>
                    {% endif %}
                </div>
                
                <button type="submit" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É</button>
            </form>
        </div>

        <!-- –ú—É–∑—ã–∫–∞ -->
        <div class="card">
            <h2>üéµ –ú—É–∑—ã–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            <form id="musicForm">
                <div class="form-group">
                    <label>–ú—É–∑—ã–∫–∞ (MP3)</label>
                    <input type="file" id="music_file" accept="audio/mp3,audio/mpeg">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        –ó–∞–≥—Ä—É–∑–∏ MP3 —Ñ–∞–π–ª —Å–æ —Å–≤–æ–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –ú—É–∑—ã–∫–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ –ø–æ—Å–µ—â–µ–Ω–∏–∏ —Ç–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
                    </small>
                    {% if current_user.profile.music_url %}
                    <div style="margin-top: 10px;">
                        <audio controls style="width: 100%; max-width: 400px;">
                            <source src="{{ current_user.profile.music_url }}" type="audio/mpeg">
                        </audio>
                    </div>
                    {% endif %}
                </div>
                
                <button type="submit" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º—É–∑—ã–∫—É</button>
            </form>
        </div>

        <!-- Discord -->
        <div class="card">
            <h2>üéÆ –ü—Ä–∏–≤—è–∑–∫–∞ Discord</h2>
            <form id="discordForm">
                <div class="form-group">
                    <label>Discord ID</label>
                    <input type="text" id="discord_id" value="{{ current_user.discord_id or '' }}" 
                           placeholder="–¢–≤–æ–π Discord ID">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        –ö–∞–∫ —É–∑–Ω–∞—Ç—å: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ ‚Üí –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ ‚Üí –ü–ö–ú –Ω–∞ —Å–µ–±—è ‚Üí –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID
                    </small>
                </div>
                
                <button type="submit" class="btn">–ü—Ä–∏–≤—è–∑–∞—Ç—å Discord</button>
            </form>
        </div>

        <!-- –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è -->
        <div class="card">
            <h2>üîí –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h2>
            <form id="passwordForm">
                <div class="form-group">
                    <label>–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="old_password" required>
                </div>
                
                <div class="form-group">
                    <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="new_password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label>–ü–æ–≤—Ç–æ—Ä–∏ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="new_password2" required minlength="6">
                </div>
                
                <button type="submit" class="btn btn-danger">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            </form>
        </div>
    </div>

    <script>
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                display_name: document.getElementById('display_name').value,
                email: document.getElementById('email').value,
                bio: document.getElementById('bio').value
            };
            await updateProfile(data);
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏
        document.getElementById('designForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('avatar_file');
            
            if (!fileInput.files || !fileInput.files[0]) {
                showMessage('–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('avatar', fileInput.files[0]);
            
            try {
                const response = await fetch('/api/upload_avatar', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage('–ê–≤–∞—Ç–∞—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏', 'error');
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º—É–∑—ã–∫–∏
        document.getElementById('musicForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('music_file');
            
            if (!fileInput.files || !fileInput.files[0]) {
                showMessage('–í—ã–±–µ—Ä–∏ MP3 —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('music', fileInput.files[0]);
            
            try {
                const response = await fetch('/api/upload_music', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage('–ú—É–∑—ã–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º—É–∑—ã–∫–∏', 'error');
            }
        });

        // –ü—Ä–∏–≤—è–∑–∫–∞ Discord
        document.getElementById('discordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const discord_id = document.getElementById('discord_id').value;
            
            try {
                const response = await fetch('/api/link_discord', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({discord_id})
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Discord —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω!', 'success');
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ Discord', 'error');
            }
        });

        // –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const old_password = document.getElementById('old_password').value;
            const new_password = document.getElementById('new_password').value;
            const new_password2 = document.getElementById('new_password2').value;
            
            if (new_password !== new_password2) {
                showMessage('–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/change_password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({old_password, new_password})
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω!', 'success');
                    document.getElementById('passwordForm').reset();
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è', 'error');
            }
        });

        async function updateProfile(data) {
            try {
                const response = await fetch('/api/update_profile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω!', 'success');
                } else {
                    showMessage(result.error, 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
            }
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.className = 'message ' + type;
            msg.textContent = text;
            window.scrollTo(0, 0);
            setTimeout(() => msg.className = '', 5000);
        }
    </script>
</body>
</html>
