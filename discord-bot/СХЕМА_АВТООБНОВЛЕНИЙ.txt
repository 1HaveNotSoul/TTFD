========================================
📊 СХЕМА РАБОТЫ СИСТЕМЫ АВТООБНОВЛЕНИЙ
========================================

📅 Дата: 07.02.2026
🎯 Версия: 2.0

========================================

🔄 ПОЛНЫЙ ЦИКЛ РАБОТЫ:

┌─────────────────────────────────────┐
│   1. РАЗРАБОТКА (Локальная машина)  │
└─────────────────────────────────────┘
              │
              ▼
    ┌─────────────────────┐
    │  Изменяешь код      │
    └─────────────────────┘
              │
              ▼
    ┌─────────────────────┐
    │  git add .          │
    └─────────────────────┘
              │
              ▼
    ┌─────────────────────────────────┐
    │  git commit -m "описание"       │
    └─────────────────────────────────┘
              │
              ▼
    ┌─────────────────────────────────┐
    │  Git Hook: post-commit          │
    │  (автоматически запускается)    │
    └─────────────────────────────────┘
              │
              ▼
    ┌─────────────────────────────────┐
    │  git_update_handler.py          │
    │  - Читает сообщение коммита     │
    │  - Форматирует текст            │
    │  - Добавляет в auto_update.json │
    └─────────────────────────────────┘
              │
              ▼
    ┌─────────────────────────────────┐
    │  auto_update.json               │
    │  {                              │
    │    "enabled": true,             │
    │    "changes": [                 │
    │      "описание изменения"       │
    │    ]                            │
    │  }                              │
    └─────────────────────────────────┘
              │
              ▼
    ┌─────────────────────┐
    │  git push           │
    └─────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│   2. СЕРВЕР (Railway/Render)        │
└─────────────────────────────────────┘
              │
              ▼
    ┌─────────────────────┐
    │  git pull           │
    │  (автоматически)    │
    └─────────────────────┘
              │
              ▼
    ┌─────────────────────────────────┐
    │  Перезапуск бота                │
    │  (вручную или автоматически)    │
    └─────────────────────────────────┘
              │
              ▼
    ┌─────────────────────────────────┐
    │  bot.py: on_ready()             │
    │  - Запуск бота                  │
    └─────────────────────────────────┘
              │
              ▼
    ┌─────────────────────────────────┐
    │  updates_system.check_auto_     │
    │  update(bot)                    │
    │  - Проверяет auto_update.json   │
    └─────────────────────────────────┘
              │
              ▼
         ┌────┴────┐
         │ Есть    │
         │ изме-   │ НЕТ → Пропускает
         │ нения?  │
         └────┬────┘
              │ ДА
              ▼
    ┌─────────────────────────────────┐
    │  send_update_notification()     │
    │  - Форматирует сообщение        │
    │  - Добавляет дату/время МСК     │
    │  - Создаёт список изменений     │
    └─────────────────────────────────┘
              │
              ▼
    ┌─────────────────────────────────┐
    │  Discord API                    │
    │  - Отправка в канал             │
    │  - ID: 1466923990936326294      │
    └─────────────────────────────────┘
              │
              ▼
    ┌─────────────────────────────────┐
    │  clear_auto_update()            │
    │  - Очищает auto_update.json     │
    │  - enabled: false               │
    │  - changes: []                  │
    └─────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│   3. DISCORD (Канал обновлений)     │
└─────────────────────────────────────┘
              │
              ▼
    ┌─────────────────────────────────┐
    │  Сообщение в канале:            │
    │                                 │
    │  **Обновление:**                │
    │  07.02.2026 12:30 МСК           │
    │                                 │
    │  **Список изменений:**          │
    │  • описание изменения           │
    └─────────────────────────────────┘

========================================

📁 СТРУКТУРА ФАЙЛОВ:

ЛОКАЛЬНАЯ МАШИНА:
├── TTFD/
│   ├── .git/hooks/
│   │   └── post-commit ⚙️ Git Hook
│   └── discord-bot/
│       └── git_update_handler.py 🔧 Обработчик
│
└── TTFD-Discord/
    ├── py/
    │   ├── bot.py 🤖 Основной файл
    │   └── updates_system.py 📢 Система обновлений
    └── json/
        └── auto_update.json 💾 Накопление изменений

СЕРВЕР:
└── /app/ (или рабочая директория)
    ├── py/
    │   ├── bot.py 🤖
    │   └── updates_system.py 📢
    └── json/
        ├── auto_update.json 💾 (очищается после отправки)
        └── version.json 📋 (не используется)

========================================

🔄 ПОТОК ДАННЫХ:

1. КОММИТ → Git Hook
   ├─ Сообщение: "добавлена функция X"
   └─ Триггер: post-commit

2. Git Hook → git_update_handler.py
   ├─ Читает: git log -1 --pretty=%B
   ├─ Форматирует: "добавлена функция X"
   └─ Сохраняет: auto_update.json

3. auto_update.json → Накопление
   ├─ Коммит 1: "добавлена функция X"
   ├─ Коммит 2: "исправлен баг Y"
   └─ Коммит 3: "обновлён дизайн Z"

4. Запуск бота → Проверка
   ├─ Читает: auto_update.json
   ├─ Находит: 3 изменения
   └─ Enabled: true

5. Отправка → Discord
   ├─ Канал: 1466923990936326294
   ├─ Формат: дата + список
   └─ Изменения: все 3 пункта

6. Очистка → auto_update.json
   ├─ enabled: false
   ├─ changes: []
   └─ Готов к новым изменениям

========================================

⚙️ КОМПОНЕНТЫ СИСТЕМЫ:

1. Git Hook (post-commit)
   ├─ Путь: TTFD/.git/hooks/post-commit
   ├─ Язык: Shell script
   ├─ Триггер: После каждого коммита
   └─ Действие: Запускает git_update_handler.py

2. git_update_handler.py
   ├─ Путь: TTFD/discord-bot/git_update_handler.py
   ├─ Язык: Python
   ├─ Функции:
   │   ├─ get_last_commit_message()
   │   ├─ format_change_message()
   │   ├─ add_update()
   │   └─ main()
   └─ Действие: Добавляет изменение в JSON

3. updates_system.py
   ├─ Путь: TTFD-Discord/py/updates_system.py
   ├─ Язык: Python
   ├─ Функции:
   │   ├─ load_auto_update()
   │   ├─ save_auto_update()
   │   ├─ set_auto_update()
   │   ├─ clear_auto_update()
   │   ├─ send_update_notification()
   │   └─ check_auto_update()
   └─ Действие: Отправляет обновления в Discord

4. bot.py
   ├─ Путь: TTFD-Discord/py/bot.py
   ├─ Язык: Python
   ├─ Интеграция: on_ready()
   └─ Действие: Вызывает check_auto_update()

5. auto_update.json
   ├─ Путь: TTFD-Discord/json/auto_update.json
   ├─ Формат: JSON
   ├─ Поля:
   │   ├─ enabled: bool
   │   └─ changes: list[str]
   └─ Действие: Хранит накопленные изменения

========================================

🎯 КЛЮЧЕВЫЕ МОМЕНТЫ:

1. АВТОМАТИЗАЦИЯ
   ✅ Git Hook запускается автоматически
   ✅ Изменения добавляются автоматически
   ✅ Отправка при запуске бота
   ✅ Очистка после отправки

2. НАКОПЛЕНИЕ
   ✅ Все коммиты между запусками
   ✅ Одно сообщение со всеми изменениями
   ✅ Нет дублирования
   ✅ Нет потери данных

3. ФОРМАТ
   ✅ Дата и время МСК
   ✅ Список изменений с буллетами
   ✅ Без номеров версий
   ✅ Красивое оформление

4. НАДЁЖНОСТЬ
   ✅ Проверка дубликатов
   ✅ Обработка ошибок
   ✅ Логирование
   ✅ Автоматическая очистка

========================================

📊 ПРИМЕРЫ СЦЕНАРИЕВ:

СЦЕНАРИЙ 1: Одно изменение
├─ Коммит: "добавлена команда !test"
├─ auto_update.json: ["добавлена команда !test"]
├─ Запуск бота
└─ Discord: "• добавлена команда !test"

СЦЕНАРИЙ 2: Несколько изменений
├─ Коммит 1: "добавлена команда !test"
├─ Коммит 2: "исправлен баг в !profile"
├─ Коммит 3: "обновлён дизайн embed"
├─ auto_update.json: [3 изменения]
├─ Запуск бота
└─ Discord: 3 пункта в одном сообщении

СЦЕНАРИЙ 3: Без изменений
├─ Запуск бота
├─ auto_update.json: пустой
└─ Discord: ничего не отправляется

СЦЕНАРИЙ 4: Несколько запусков
├─ Коммит: "добавлена функция"
├─ Запуск 1: отправлено в Discord
├─ auto_update.json: очищен
├─ Запуск 2: ничего не отправляется
└─ Ждёт новых коммитов

========================================

🔍 ОТЛАДКА:

ПРОВЕРКА 1: Git Hook работает?
├─ Сделай коммит
├─ Проверь вывод в консоли
└─ Должно быть: "✅ Добавлено обновление"

ПРОВЕРКА 2: Изменения добавляются?
├─ Открой auto_update.json
├─ Должно быть: enabled: true
└─ Должно быть: changes: [...]

ПРОВЕРКА 3: Бот отправляет?
├─ Запусти бота
├─ Проверь логи
└─ Должно быть: "✅ Уведомление отправлено"

ПРОВЕРКА 4: Сообщение в Discord?
├─ Открой канал 1466923990936326294
├─ Должно быть: новое сообщение
└─ Формат: дата + список изменений

ПРОВЕРКА 5: Очистка работает?
├─ После отправки
├─ Открой auto_update.json
└─ Должно быть: enabled: false, changes: []

========================================

✅ СИСТЕМА ГОТОВА!

Все компоненты на месте и работают вместе.
Следуй схеме для понимания потока данных.

========================================

📅 Дата: 07.02.2026 12:30 МСК
🎯 Версия: 2.0
👨‍💻 Автор: Kiro AI Assistant

========================================
