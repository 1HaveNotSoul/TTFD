# üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º

**–î–∞—Ç–∞:** 08.02.2026  
**–í—Ä–µ–º—è:** ~2 —á–∞—Å–∞ –Ω–∞ –≤—Å—ë

---

## ‚úÖ –ß—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ

- ‚úÖ Unified Database –º–æ–¥–µ–ª–∏ –∏ –º–∏–≥—Ä–∞—Ü–∏—è
- ‚úÖ –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –¥–ª—è –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
- ‚úÖ Sync Worker –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π

---

## üöÄ –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î (5 –º–∏–Ω—É—Ç)

### –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ psql

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ PostgreSQL
psql $DATABASE_URL

# –ü—Ä–∏–º–µ–Ω–∏ –º–∏–≥—Ä–∞—Ü–∏—é
\i TTFD/shared/migration_unified.sql

# –ü—Ä–æ–≤–µ—Ä—å —Ç–∞–±–ª–∏—Ü—ã
SELECT COUNT(*) FROM unified_users;
SELECT COUNT(*) FROM cross_platform_events;

# –í—ã—Ö–æ–¥
\q
```

### –í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ Python

```python
import asyncio
from TTFD.shared.database_unified import get_unified_db

async def test():
    db = await get_unified_db()
    print("‚úÖ Unified Database –ø–æ–¥–∫–ª—é—á–µ–Ω–∞")
    await db.disconnect()

asyncio.run(test())
```

---

## üöÄ –®–∞–≥ 2: –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (10 –º–∏–Ω—É—Ç)

```bash
cd TTFD/shared
python migrate_to_unified.py
```

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç:**
1. –ú–∏–≥—Ä–∞—Ü–∏—è Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. –ú–∏–≥—Ä–∞—Ü–∏—è Discord –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Å –ø—Ä–∏–≤—è–∑–∫–æ–π)
3. –ú–∏–≥—Ä–∞—Ü–∏—è Website –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (—Å –ø—Ä–∏–≤—è–∑–∫–æ–π)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```sql
SELECT 
    COUNT(*) as total,
    COUNT(telegram_id) as telegram,
    COUNT(discord_id) as discord,
    COUNT(website_email) as website
FROM unified_users;
```

---

## üöÄ –®–∞–≥ 3: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Telegram Bot (30 –º–∏–Ω—É—Ç)

### 3.1 –û–±–Ω–æ–≤–∏—Ç—å main_v3.py

–î–æ–±–∞–≤—å –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞:

```python
# –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ infrastructure
from infrastructure.database.unified_integration import get_unified_integration
```

–î–æ–±–∞–≤—å –≤ `async def main()`:

```python
# –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
print("\nüîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Unified Database...")
try:
    unified_integration = await get_unified_integration()
    print("‚úÖ Unified Database –ø–æ–¥–∫–ª—é—á–µ–Ω–∞")
except Exception as e:
    print(f"‚ö†Ô∏è  Unified Database –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: {e}")
    unified_integration = None
```

### 3.2 –û–±–Ω–æ–≤–∏—Ç—å UserService

–í `domain/services/user_service.py` –¥–æ–±–∞–≤—å:

```python
from infrastructure.database.unified_integration import get_unified_integration

class UserService:
    def __init__(self, user_repo, cache):
        self.user_repo = user_repo
        self.cache = cache
        self.unified = None  # –ë—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–∑–∂–µ
    
    async def set_unified(self, unified):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å unified integration"""
        self.unified = unified
    
    async def get_or_create_user(self, telegram_id, username, display_name):
        # –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è —á–µ—Ä–µ–∑ unified
        if self.unified:
            try:
                unified_user = await self.unified.get_or_create_user(
                    telegram_id, username, display_name
                )
                # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
                # ...
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ unified: {e}")
        
        # Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
        return await self.user_repo.get_or_create(telegram_id, username, display_name)
```

### 3.3 –ó–∞–ø—É—Å—Ç–∏—Ç—å Sync Worker

–í `main_v3.py` –¥–æ–±–∞–≤—å:

```python
# –í –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
import sys
sys.path.append('../shared')
from sync_worker import get_sync_worker

# –í async def main() –ø–æ—Å–ª–µ unified_integration
if unified_integration:
    print("üîÑ –ó–∞–ø—É—Å–∫ Sync Worker...")
    sync_worker = await get_sync_worker()
    print("‚úÖ Sync Worker –∑–∞–ø—É—â–µ–Ω")
```

---

## üöÄ –®–∞–≥ 4: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Discord Bot (30 –º–∏–Ω—É—Ç)

### 4.1 –û–±–Ω–æ–≤–∏—Ç—å bot.py

–î–æ–±–∞–≤—å –≤ –Ω–∞—á–∞–ª–æ:

```python
import sys
sys.path.append('../../shared')
from unified_integration import get_discord_unified
```

–î–æ–±–∞–≤—å –≤ `on_ready()`:

```python
# –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –∏–≥—Ä–æ–π
print("üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Unified Database...")
try:
    global unified_integration
    unified_integration = await get_discord_unified()
    print("‚úÖ Unified Database –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ (Discord)")
except Exception as e:
    print(f"‚ö†Ô∏è  Unified Database –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: {e}")
    unified_integration = None
```

### 4.2 –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ XP

–í `on_voice_state_update`:

```python
# –ü–æ—Å–ª–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è XP —á–µ—Ä–µ–∑ db
if unified_integration:
    try:
        await unified_integration.record_voice_time(
            str(member.id),
            duration,
            xp_earned
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ unified: {e}")
```

–í `on_message`:

```python
# –ü–æ—Å–ª–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è XP —á–µ—Ä–µ–∑ db
if unified_integration:
    try:
        await unified_integration.record_message(
            str(message.author.id),
            xp_reward
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ unified: {e}")
```

---

## üöÄ –®–∞–≥ 5: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Website (30 –º–∏–Ω—É—Ç)

### 5.1 –û–±–Ω–æ–≤–∏—Ç—å app.py

–î–æ–±–∞–≤—å –≤ –Ω–∞—á–∞–ª–æ:

```python
from unified_integration import get_website_unified

# –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è app
print("üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Unified Database...")
try:
    unified_integration = get_website_unified()
    print("‚úÖ Unified Database –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ (Website)")
except Exception as e:
    print(f"‚ö†Ô∏è  Unified Database –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: {e}")
    unified_integration = None
```

### 5.2 –û–±–Ω–æ–≤–∏—Ç—å —Ä–æ—É—Ç—ã

–í `/profile`:

```python
@app.route('/profile')
def profile():
    current_user = get_current_user()
    if not current_user:
        return redirect(url_for('login'))
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ unified
    if unified_integration:
        try:
            stats = unified_integration.get_user_stats(current_user['email'])
            if stats:
                current_user.update(stats)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ unified: {e}")
    
    return render_template('profile.html', user=current_user)
```

–í `/auth/discord/callback`:

```python
# –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ OAuth
if unified_integration and result['success']:
    try:
        # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º Discord –∫ –∞–∫–∫–∞—É–Ω—Ç—É
        unified_integration.link_discord(
            result['account']['email'],
            result['discord_user']['id']
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ unified: {e}")
```

---

## üöÄ –®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (20 –º–∏–Ω—É—Ç)

### 6.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram Bot

```bash
cd TTFD/telegram-bot
python main_v3.py
```

–û—Ç–ø—Ä–∞–≤—å `/start` –±–æ—Ç—É –∏ –ø—Ä–æ–≤–µ—Ä—å:
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ unified_users
- ‚úÖ XP –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è
- ‚úÖ –°–æ–±—ã—Ç–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ cross_platform_events

### 6.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ Discord Bot

```bash
cd TTFD-Discord
python py/bot.py
```

–û—Ç–ø—Ä–∞–≤—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Discord –∏ –ø—Ä–æ–≤–µ—Ä—å:
- ‚úÖ XP –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è
- ‚úÖ –°–æ–±—ã—Ç–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è
- ‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è

### 6.3 –ü—Ä–æ–≤–µ—Ä–∫–∞ Website

–û—Ç–∫—Ä–æ–π Website –∏ –ø—Ä–æ–≤–µ—Ä—å:
- ‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ unified
- ‚úÖ Discord OAuth –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –∞–∫–∫–∞—É–Ω—Ç—ã
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

### 6.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

```sql
-- –ü—Ä–æ–≤–µ—Ä—å —Å–æ–±—ã—Ç–∏—è
SELECT * FROM cross_platform_events 
WHERE processed = false 
ORDER BY created_at DESC 
LIMIT 10;

-- –ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT * FROM unified_users 
WHERE telegram_id = 'YOUR_TELEGRAM_ID';
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Telegram

1. –û—Ç–ø—Ä–∞–≤—å `/start` –≤ Telegram
2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Å–æ–∑–¥–∞–ª—Å—è –≤ unified_users
3. –°—ã–≥—Ä–∞–π –∏–≥—Ä—É
4. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ XP –æ–±–Ω–æ–≤–∏–ª—Å—è
5. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–ª–æ—Å—å

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–∏–≤—è–∑–∫–∞ Discord

1. –í–æ–π–¥–∏ –Ω–∞ Website —á–µ—Ä–µ–∑ Discord OAuth
2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ discord_id –ø—Ä–∏–≤—è–∑–∞–ª—Å—è
3. –û—Ç–ø—Ä–∞–≤—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Discord
4. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ XP –æ–±–Ω–æ–≤–∏–ª—Å—è –≤ unified_users
5. –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ Website - –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–π XP

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

1. –ü–æ–ª—É—á–∏ XP –≤ Telegram
2. –ü–æ–¥–æ–∂–¥–∏ 5 —Å–µ–∫—É–Ω–¥ (Sync Worker)
3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
4. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–Ω—ã –Ω–∞ Website

---

## üêõ Troubleshooting

### –û—à–∏–±–∫–∞: "DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

```bash
export DATABASE_URL="postgresql://..."
```

### –û—à–∏–±–∫–∞: "–¢–∞–±–ª–∏—Ü–∞ unified_users –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

```bash
psql $DATABASE_URL -f TTFD/shared/migration_unified.sql
```

### –û—à–∏–±–∫–∞: "ModuleNotFoundError: No module named 'models'"

–ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ `sys.path.append` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π:

```python
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..', 'shared'))
```

### Sync Worker –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è

–ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –æ–Ω –∑–∞–ø—É—â–µ–Ω:

```python
# –í main_v3.py –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
sync_worker = await get_sync_worker()
```

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ —É —Ç–µ–±—è –±—É–¥–µ—Ç:
- ‚úÖ –ï–¥–∏–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è XP/–º–æ–Ω–µ—Ç/—Ä–∞–Ω–≥–æ–≤
- ‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –º–µ–∂–¥—É –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏
- ‚úÖ –°–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–í—Ä–µ–º—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:** ~2 —á–∞—Å–∞  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–≤—è–∑–∞–Ω–Ω–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ TTFD
